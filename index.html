<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planner RitualÃ­stico â€” GrimÃ³rio Completo</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- Fontes otimizadas para leitura -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Inter:wght@300;400;500;600&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
  
  <style>
    /* VARIÃVEIS DE CORES - PALETA ACESSÃVEL 2026 */
    :root {
      /* Cores neutras orgÃ¢nicas - PAPEL COMO PADRÃƒO DEFINITIVO */
      --color-cloud-dancer: #e8dfca; /* Papel reciclado como cor definitiva */
      --color-bone-white: #f9f6ef;   /* Tom de pergaminho suave */
      --color-parchment: #f5f1e8;    /* Pergaminho claro */
      
      /* Cores de texto */
      --color-obsidian: #1a1a1a;     /* Quase preto, melhor que #000 */
      --color-deep-teal: #0d2b2e;    /* Verde muito escuro */
      --color-text-primary: #121212; /* Cinza escuro para melhor legibilidade */
      --color-text-secondary: #424242;
      
      /* Cores de destaque - TendÃªncias 2026 */
      --color-digital-lavender: #b5a8ff; /* Cor do ano 2026 */
      --color-transformative-teal: #2a7a7a; /* Verde-azulado transformativo */
      --color-mystic-purple: #7e57c2;     /* Roxo mÃ­stico */
      --color-sunset-amber: #ff8a50;      /* Ã‚mbar do pÃ´r do sol */
      
      /* Tipografia */
      --font-heading: 'Cormorant Garamond', Georgia, serif;
      --font-body: 'Inter', 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mystic: 'Cormorant Garamond', serif;
      
      /* EspaÃ§amento */
      --line-height-body: 1.6;
      --line-height-heading: 1.3;
      --letter-spacing-wide: 0.02em;
      --letter-spacing-tight: -0.01em;
      
      /* Bordas */
      --border-radius-sm: 8px;
      --border-radius-md: 12px;
      --border-radius-lg: 20px;
      
      /* Sombras suaves */
      --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.05);
      --shadow-medium: 0 8px 24px rgba(0, 0, 0, 0.08);
      --shadow-deep: 0 12px 36px rgba(0, 0, 0, 0.12);
    }
    
    /* ESTILOS GERAIS DO CORPO - FUNDO EM PAPEL DEFINITIVO */
    body {
      font-family: var(--font-body);
      background: var(--color-cloud-dancer); /* Cor de papel reciclado como padrÃ£o */
      margin: 0;
      padding: 0;
      color: var(--color-text-primary);
      min-height: 100vh;
      line-height: var(--line-height-body);
      letter-spacing: var(--letter-spacing-wide);
    }

    body::before {
      content: 'â˜¾ âœ¶ âš â˜¿ â™€ â™‚ âš— ğŸœƒ ğŸœ ğŸœ‚ ğŸœ„';
      position: fixed;
      inset: 0;
      opacity: 0.03;
      font-size: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      font-family: var(--font-mystic);
      color: var(--color-text-secondary);
    }

    /* TELA DE INSTALAÃ‡ÃƒO */
    #installOverlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--color-transformative-teal), var(--color-deep-teal));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    #installContainer {
      background: var(--color-bone-white);
      padding: 32px;
      border-radius: var(--border-radius-lg);
      width: 90%;
      max-width: 420px;
      border: 1px solid rgba(0,0,0,0.1);
      text-align: center;
      box-sizing: border-box;
      box-shadow: var(--shadow-deep);
    }

    /* TELA DE FORMULÃRIO */
    #formOverlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #e7dff0, #cbb7d8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    #formContainer {
      background: var(--color-bone-white);
      padding: 28px;
      border-radius: var(--border-radius-lg);
      width: 90%;
      max-width: 400px;
      border: 1px solid rgba(0,0,0,0.1);
      margin: 20px auto;
      box-sizing: border-box;
      box-shadow: var(--shadow-deep);
    }

    /* TIPOGRAFIA - TÃTULOS */
    h1, h2, h3, h4 {
      font-family: var(--font-heading);
      color: var(--color-deep-teal);
      font-weight: 600;
      line-height: var(--line-height-heading);
      letter-spacing: var(--letter-spacing-tight);
      margin-top: 0;
    }

    h1 {
      font-size: 2.5rem;
      text-align: center;
      margin: 20px 0;
      color: var(--color-transformative-teal);
    }

    h2 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    h3 {
      font-size: 1.5rem;
      margin-bottom: 0.75rem;
    }

    h4 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }

    /* TIPOGRAFIA - CORPO */
    .texto, p, label, input, select, textarea, button {
      font-family: var(--font-body);
      font-size: 1rem; /* 16px base */
      line-height: var(--line-height-body);
      color: var(--color-text-primary);
    }

    label {
      display: block;
      margin-top: 16px;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--color-text-secondary);
    }

    /* BOTÃ•ES - ACESSÃVEIS */
    button {
      margin-top: 12px;
      background: var(--color-transformative-teal);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--border-radius-md);
      cursor: pointer;
      font-family: var(--font-body);
      font-weight: 500;
      font-size: 1rem;
      letter-spacing: var(--letter-spacing-wide);
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover, button:focus {
      background: var(--color-digital-lavender);
      transform: translateY(-2px);
      box-shadow: var(--shadow-soft);
      outline: 2px solid var(--color-digital-lavender);
      outline-offset: 2px;
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: transparent;
      border: 2px solid var(--color-transformative-teal);
      color: var(--color-transformative-teal);
    }

    button.secondary:hover {
      background: var(--color-transformative-teal);
      color: white;
    }

    /* INPUTS E FORMULÃRIOS */
    input, select, textarea {
      width: 100%;
      margin-bottom: 12px;
      box-sizing: border-box;
      padding: 12px 16px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: var(--border-radius-sm);
      background: white;
      font-family: var(--font-body);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: 2px solid var(--color-digital-lavender);
      border-color: transparent;
      box-shadow: 0 0 0 3px rgba(181, 168, 255, 0.1);
    }

    /* RESTANTE DO CSS ORIGINAL (ADAPTADO) */
    #capa, #planner, #prospera {
      display: none;
      padding: 24px;
      box-sizing: border-box;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      background: var(--color-bone-white);
      border-radius: var(--border-radius-lg);
      margin-top: 20px;
      box-shadow: var(--shadow-soft);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .dia {
      background: white;
      min-height: 120px;
      border-radius: var(--border-radius-md);
      padding: 12px;
      cursor: pointer;
      position: relative;
      color: var(--color-mystic-purple);
      font-size: 1rem;
      border: 1px solid rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }

    .dia:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-soft);
      border-color: var(--color-digital-lavender);
    }

    .dias-semana div {
      text-align: center;
      font-weight: 600;
      padding: 12px 0;
      color: var(--color-transformative-teal);
      font-family: var(--font-heading);
      font-size: 1.1rem;
    }

    .preview {
      font-size: 0.875rem;
      margin-top: 8px;
      font-style: italic;
      word-break: break-word;
      color: var(--color-text-secondary);
      line-height: 1.4;
    }

    .estrela {
      position: absolute;
      bottom: 12px;
      right: 12px;
      font-size: 1rem;
      color: var(--color-sunset-amber);
    }

    .iconesTopo {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 4px;
      font-size: 0.875rem;
    }

    .top-nav {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .legenda {
      font-size: 0.875rem;
      margin: 16px 0;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: center;
      color: var(--color-text-secondary);
    }

    /* MAIN RESPONSIVO */
    main {
      display: grid;
      grid-template-columns: 1fr;
      gap: 32px;
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 20px;
      box-sizing: border-box;
    }

    section {
      background: var(--color-bone-white);
      padding: 24px;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(0,0,0,0.05);
      width: 100%;
      box-sizing: border-box;
    }

    .texto {
      color: var(--color-text-secondary);
      font-size: 1.0625rem; /* 17px para melhor leitura */
      line-height: var(--line-height-body);
      text-align: justify;
      margin-bottom: 1.5rem;
    }

    .livro label {
      display: block;
      margin-top: 20px;
      font-size: 0.9375rem;
    }

    .livro input {
      width: 100%;
      box-sizing: border-box;
      padding: 12px 16px;
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(0,0,0,0.1);
      background: white;
      font-family: var(--font-body);
    }

    .caixa {
      box-sizing: border-box;
      background: white;
      color: var(--color-text-primary);
      padding: 20px;
      border-radius: var(--border-radius-md);
      margin-top: 24px;
      overflow-x: auto;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .lateral {
      position: static;
      top: auto;
    }

    .lunar {
      background: var(--color-bone-white);
      border: 2px dashed var(--color-transformative-teal);
      padding: 24px;
      border-radius: var(--border-radius-md);
      font-size: 0.9375rem;
    }

    .lunar strong {
      color: var(--color-transformative-teal);
    }

    .tabela {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      min-width: 300px;
    }

    .tabela th, .tabela td {
      border-bottom: 1px solid rgba(0,0,0,0.1);
      padding: 12px;
      font-size: 0.9375rem;
    }

    .tabela th {
      color: var(--color-transformative-teal);
      font-weight: 600;
      text-align: left;
    }

    .tabela input {
      width: 100%;
      box-sizing: border-box;
      border: none;
      background: transparent;
      font-family: var(--font-body);
      font-size: 0.9375rem;
    }

    .total-secao {
      margin-top: 16px;
      font-size: 0.9375rem;
      color: var(--color-transformative-teal);
      font-weight: 600;
    }

    .saldo {
      margin-top: 24px;
      padding: 20px;
      background: linear-gradient(135deg, var(--color-digital-lavender), var(--color-mystic-purple));
      border-radius: var(--border-radius-md);
      color: white;
      font-weight: 600;
    }

    .grafico {
      margin-top: 24px;
      background: var(--color-bone-white);
      border: 1px solid var(--color-transformative-teal);
      border-radius: var(--border-radius-md);
      padding: 20px;
      color: var(--color-transformative-teal);
      font-size: 0.9375rem;
    }

    /* MODAL RESPONSIVO */
    #modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 2000;
    }

    #modal > div {
      background: var(--color-bone-white);
      padding: 24px;
      border-radius: var(--border-radius-lg);
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
      margin: 0 auto;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-deep);
    }

    .sentimentos-section {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: var(--border-radius-md);
      border: 1px solid rgba(0,0,0,0.05);
    }

    .sentimentos-section label {
      display: block;
      margin-bottom: 12px;
      color: var(--color-transformative-teal);
      font-weight: 600;
      font-size: 1rem;
    }

    #sentimentos {
      width: 100%;
      min-height: 100px;
      padding: 16px;
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(0,0,0,0.1);
      background: white;
      font-family: var(--font-body);
      font-size: 1rem;
      resize: vertical;
      box-sizing: border-box;
      line-height: var(--line-height-body);
    }

    .nota-item {
      margin: 12px 0;
      padding: 16px;
      background: white;
      border-radius: var(--border-radius-md);
      border-left: 4px solid var(--color-transformative-teal);
      position: relative;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .nota-hora {
      font-size: 0.8125rem;
      color: var(--color-transformative-teal);
      font-weight: 600;
      margin-right: 40px;
    }

    .nota-texto {
      font-size: 0.9375rem;
      color: var(--color-text-primary);
      margin-top: 8px;
      margin-right: 40px;
      line-height: var(--line-height-body);
    }

    .btn-apagar-nota {
      position: absolute;
      top: 12px;
      right: 12px;
      background: transparent;
      border: none;
      color: var(--color-text-secondary);
      cursor: pointer;
      font-size: 0.875rem;
      padding: 6px 8px;
      border-radius: var(--border-radius-sm);
      transition: all 0.3s ease;
    }

    .btn-apagar-nota:hover {
      background: rgba(255, 138, 80, 0.1);
      transform: scale(1.1);
      color: var(--color-sunset-amber);
    }

    .sentimento-item {
      margin: 12px 0;
      padding: 16px;
      background: white;
      border-radius: var(--border-radius-md);
      border-left: 4px solid var(--color-mystic-purple);
      position: relative;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .btn-apagar-sentimento {
      position: absolute;
      top: 12px;
      right: 12px;
      background: transparent;
      border: none;
      color: var(--color-text-secondary);
      cursor: pointer;
      font-size: 0.875rem;
      padding: 6px 8px;
      border-radius: var(--border-radius-sm);
      transition: all 0.3s ease;
    }

    .btn-apagar-sentimento:hover {
      background: rgba(126, 87, 194, 0.1);
      transform: scale(1.1);
      color: var(--color-mystic-purple);
    }

    .oraculo-section {
      margin-bottom: 24px;
      padding: 20px;
      background: white;
      border-radius: var(--border-radius-md);
      border: 1px solid rgba(0,0,0,0.05);
    }

    .oraculo-title {
      color: var(--color-transformative-teal);
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 1.25rem;
      font-family: var(--font-heading);
    }

    .oraculo-text {
      color: var(--color-text-primary);
      font-size: 1rem;
      line-height: var(--line-height-body);
    }

    /* BotÃ£o instalar */
    #btnInstalarAgora {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: none;
      background: var(--color-digital-lavender);
    }

    /* SEÃ‡ÃƒO DE NOTIFICAÃ‡Ã•ES NO MODAL */
    .notificacoes-section {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: var(--border-radius-md);
      border: 1px solid rgba(0,0,0,0.05);
    }

    .notificacoes-section label {
      display: block;
      margin-bottom: 8px;
      color: var(--color-transformative-teal);
      font-weight: 500;
    }

    .notificacoes-section input[type="time"],
    .notificacoes-section input[type="number"] {
      width: 100%;
      margin-bottom: 12px;
    }

    .notificacoes-section select {
      width: 100%;
      margin-bottom: 12px;
    }

    /* MODAL DE CONFIGURAÃ‡ÃƒO DE NOTIFICAÃ‡Ã•ES */
    #modalNotificacoes {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    #modalNotificacoes > div {
      background: var(--color-bone-white);
      padding: 24px;
      border-radius: var(--border-radius-lg);
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-deep);
    }

    /* MEDIA QUERIES - RESPONSIVIDADE */
    @media (min-width: 768px) {
      main {
        grid-template-columns: 1.5fr 1fr;
        margin: 32px auto;
      }
      
      .lateral {
        position: sticky;
        top: 32px;
      }
      
      .grid {
        gap: 10px;
      }
      
      .dia {
        min-height: 140px;
        padding: 16px;
        font-size: 1.1rem;
      }
      
      h1 {
        font-size: 3rem;
      }
      
      h2 {
        font-size: 2.25rem;
      }
      
      h3 {
        font-size: 1.75rem;
      }
      
      /* Aumenta o tamanho da fonte para tablets */
      body {
        font-size: 1.0625rem;
      }
    }

    @media (max-width: 480px) {
      body::before {
        font-size: 80px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      h2, h3 {
        font-size: 1.5rem;
      }
      
      .grid {
        gap: 4px;
      }
      
      .dia {
        min-height: 100px;
        padding: 8px;
        font-size: 0.9375rem;
      }
      
      #modal > div {
        padding: 20px;
      }
      
      .oraculo-section {
        padding: 16px;
      }
      
      .nota-item, .sentimento-item {
        padding: 12px;
      }
      
      .btn-apagar-nota, .btn-apagar-sentimento {
        top: 8px;
        right: 8px;
        font-size: 0.8125rem;
      }
      
      /* Aumenta o tamanho da fonte para mobile */
      body {
        font-size: 1rem; /* 16px mÃ­nimo para acessibilidade */
      }
      
      input, select, textarea, button {
        font-size: 1rem; /* Garante tamanho mÃ­nimo */
      }
    }

    /* AJUSTES DE CONTRASTE WCAG */
    .oraculo-text {
      color: var(--color-text-primary);
      background: white;
    }
    
    .nota-texto {
      color: var(--color-text-primary);
    }
    
    /* Foco visÃ­vel para acessibilidade */
    *:focus {
      outline: 2px solid var(--color-digital-lavender);
      outline-offset: 2px;
    }
    
    /* Melhorando o contraste dos botÃµes */
    button {
      color: white;
      background-color: var(--color-transformative-teal);
    }
    
    button:hover {
      background-color: var(--color-digital-lavender);
    }
    
    /* Contraste nos links */
    a {
      color: var(--color-transformative-teal);
      text-decoration: underline;
    }
    
    a:hover {
      color: var(--color-digital-lavender);
    }
    
    /* EspaÃ§amento entre parÃ¡grafos */
    p {
      margin-bottom: 1.5rem;
    }
    
    /* Hierarquia clara de cabeÃ§alhos */
    h1 { margin-bottom: 2rem; }
    h2 { margin-bottom: 1.5rem; }
    h3 { margin-bottom: 1rem; }
    h4 { margin-bottom: 0.75rem; }
  </style>
</head>
<body>

<!-- TELA DE INSTALAÃ‡ÃƒO -->
<div id="installOverlay">
  <div id="installContainer">
    <h2>âœ¨ Instalar GrimÃ³rio RitualÃ­stico âœ¨</h2>
    <p>Instale o aplicativo para uma experiÃªncia completa, com notificaÃ§Ãµes lunares e acesso offline.</p>
    <button id="btnInstalarPWA">ğŸ“² Instalar Agora</button>
    <button id="btnPularInstalacao" class="secondary">ğŸŒ Usar na Web</button>
    <p style="font-size:0.875rem;margin-top:20px;opacity:0.8;">
      VocÃª pode instalar depois a qualquer momento atravÃ©s do menu do navegador.
    </p>
  </div>
</div>

<!-- TELA DE FORMULÃRIO -->
<div id="formOverlay">
  <div id="formContainer">
    <h3>IdentificaÃ§Ã£o da Bruxa</h3>
    <label>Seu nome mÃ¡gico</label>
    <input id="nome" placeholder="Digite seu nome ou apelido" autocomplete="off">
    <label>Signo</label>
    <select id="signo">
      <option value="">Selecione seu signo</option>
      <option>Ãries</option><option>Touro</option><option>GÃªmeos</option>
      <option>CÃ¢ncer</option><option>LeÃ£o</option><option>Virgem</option>
      <option>Libra</option><option>EscorpiÃ£o</option><option>SagitÃ¡rio</option>
      <option>CapricÃ³rnio</option><option>AquÃ¡rio</option><option>Peixes</option>
    </select>
    <label>Ano pessoal (opcional)</label>
    <select id="anoPessoal">
      <option value="">Selecione seu ano pessoal</option>
      <option>1</option><option>2</option><option>3</option><option>4</option>
      <option>5</option><option>6</option><option>7</option><option>8</option><option>9</option>
    </select>
    <label>Data de nascimento (para numerologia)</label>
    <input id="dataNascimento" type="date">
    <label>PrÃ³ximo ciclo menstrual (opcional)</label>
    <input id="ciclo" type="date">
    <button id="salvar">âœ¨ Entrar no GrimÃ³rio</button>
    <p style="font-size:0.875rem;margin-top:15px;opacity:0.8;">
      Seus dados sÃ£o armazenados apenas no seu dispositivo.
    </p>
  </div>
</div>

<!-- BotÃ£o para instalar depois -->
<button id="btnInstalarAgora" style="display:none">
  ğŸ“² Instalar
</button>

<!-- CAPA -->
<div id="capa">
  <h2>Bem-vinda ao GrimÃ³rio</h2>
  <p id="nomeCapa"></p>
  <button id="irPlanner">ğŸ“… Planner Mensal</button>
  <button id="irProspera">ğŸ’° Livro da Bruxa PrÃ³spera</button>
  <div style="margin-top:30px;">
    <button id="btnAlterarNome" class="secondary">âœï¸ Alterar meus dados</button>
    <button id="btnConfigNotificacoes" class="secondary">ğŸ”” Configurar NotificaÃ§Ãµes</button>
  </div>
</div>

<!-- PLANNER -->
<div id="planner">
  <div class="top-nav"><button id="voltarCapa" class="secondary">âŸµ Capa</button></div>
  <h2 id="perfil"></h2>
  <div class="legenda">
    <span>ğŸŒ‘ğŸŒ’ğŸŒ•ğŸŒ˜ LunaÃ§Ã£o</span>
    <span>ğŸ”¥ SabÃ¡</span>
    <span>â³ Lua fora de curso</span>
  </div>
  <div id="mesTitulo"></div>
  <div style="display:flex;justify-content:space-between;margin:16px 0">
    <button id="mesAnterior">â—€</button>
    <button id="mesProximo">â–¶</button>
  </div>
  <div class="grid dias-semana"><div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>SÃ¡b</div></div>
  <div class="grid" id="grid"></div>
</div>

<!-- MODAL ATUALIZADO -->
<div id="modal" style="display:none">
  <div>
    <h3 id="modalTitulo" style="color:var(--color-transformative-teal);margin-bottom:20px;"></h3>
    
    <!-- ORÃCULO -->
    <div class="oraculo-section">
      <div class="oraculo-title">ğŸŒ™ OrÃ¡culo do Dia</div>
      <div id="oraculo" class="oraculo-text"></div>
    </div>
    
    <!-- SEÃ‡ÃƒO DE NOTAS SALVAS -->
    <div id="notasSalvas"></div>
    
    <!-- SEÃ‡ÃƒO DE SENTIMENTOS SALVOS -->
    <div id="sentimentosSalvos" style="margin-top:20px;"></div>
    
    <!-- FORMULÃRIO PARA NOVA NOTA -->
    <div style="margin-top:24px;padding-top:20px;border-top:2px dashed var(--color-transformative-teal);">
      <h4 style="color:var(--color-transformative-teal);margin-bottom:16px;">â• Nova Nota</h4>
      <input type="time" id="notaHora" style="margin-bottom:16px;" />
      <textarea id="notaTexto" placeholder="Escreva sua nota aqui..." style="height:100px;width:100%;box-sizing:border-box;margin-bottom:20px;"></textarea>
      
      <!-- SEÃ‡ÃƒO DE NOTIFICAÃ‡Ã•ES PARA A NOTA -->
      <div class="notificacoes-section">
        <label for="notificarNota">ğŸ”” Receber lembrete desta nota?</label>
        <select id="notificarNota">
          <option value="nao">NÃ£o receber notificaÃ§Ã£o</option>
          <option value="sim">Sim, receber notificaÃ§Ã£o</option>
        </select>
        
        <div id="configNotificacao" style="display:none;">
          <label for="tempoAntecedencia">Tempo de antecedÃªncia:</label>
          <select id="tempoAntecedencia">
            <option value="5">5 minutos antes</option>
            <option value="15">15 minutos antes</option>
            <option value="30">30 minutos antes</option>
            <option value="60">1 hora antes</option>
            <option value="120">2 horas antes</option>
            <option value="1440">1 dia antes</option>
          </select>
        </div>
      </div>
      
      <!-- CAMPO: IMPRESSÃ•ES E SENTIMENTOS -->
      <div class="sentimentos-section">
        <label for="sentimentos">ğŸ’– ImpressÃµes e Sentimentos</label>
        <textarea id="sentimentos" placeholder="Como vocÃª estÃ¡ se sentindo? Quais foram suas impressÃµes deste dia? Escreva livremente..."></textarea>
      </div>
      
      <div style="display:flex;gap:12px;margin-top:20px;">
        <button id="btnSalvarNota">ğŸ’¾ Salvar Nota</button>
        <button id="btnFechar" class="secondary">âœ– Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE CONFIGURAÃ‡ÃƒO DE NOTIFICAÃ‡Ã•ES -->
<div id="modalNotificacoes" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:2000; padding:20px;">
  <div style="background:var(--color-bone-white); padding:24px; border-radius:var(--border-radius-lg); width:100%; max-width:500px; box-sizing:border-box; max-height:90vh; overflow-y:auto;">
    <h3 style="color:var(--color-transformative-teal);margin-bottom:20px;">ğŸ”” Configurar NotificaÃ§Ãµes</h3>
    
    <div class="notificacoes-section">
      <label for="notificacoesAtivas">ğŸ“¢ Ativar notificaÃ§Ãµes?</label>
      <select id="notificacoesAtivas">
        <option value="sim">Sim, receber notificaÃ§Ãµes</option>
        <option value="nao">NÃ£o receber notificaÃ§Ãµes</option>
      </select>
      
      <label for="horaNotificacaoDiaria">â° Hora para notificaÃ§Ã£o diÃ¡ria:</label>
      <input type="time" id="horaNotificacaoDiaria" value="08:00">
      
      <label for="notificarSabas">ğŸ”¥ Notificar sobre SabÃ¡s?</label>
      <select id="notificarSabas">
        <option value="sim">Sim, notificar sobre SabÃ¡s</option>
        <option value="nao">NÃ£o notificar sobre SabÃ¡s</option>
      </select>
      
      <label for="antecedenciaSabas">ğŸ“… AntecedÃªncia para SabÃ¡s:</label>
      <select id="antecedenciaSabas">
        <option value="1">1 dia antes</option>
        <option value="2">2 dias antes</option>
        <option value="3">3 dias antes</option>
        <option value="7">1 semana antes</option>
      </select>
      
      <label for="horaNotificacaoSabas">â° Hora para notificaÃ§Ã£o de SabÃ¡s:</label>
      <input type="time" id="horaNotificacaoSabas" value="09:00">
    </div>
    
    <div style="display:flex;gap:12px;margin-top:20px;">
      <button id="btnSalvarConfigNotificacoes">ğŸ’¾ Salvar ConfiguraÃ§Ãµes</button>
      <button id="btnFecharNotificacoes" class="secondary">âœ– Fechar</button>
    </div>
    
    <p style="font-size:0.875rem;margin-top:15px;opacity:0.8;">
      As notificaÃ§Ãµes funcionam melhor com o aplicativo instalado.
    </p>
  </div>
</div>

<!-- BRUXA PRÃ“SPERA -->
<div id="prospera">
  <div class="top-nav"><button id="voltarCapa2" class="secondary">âŸµ Capa</button></div>
 <h1>ğŸ“– Livro da Bruxa PrÃ³spera</h1>

<main>

  <section class="livro">

    <h2>âœ¦ Fonte de AbundÃ¢ncia</h2>
    <div class="texto">Registre todos os ganhos que chegam atÃ© vocÃª atravÃ©s do seu trabalho, trocas, serviÃ§os ou vendas.</div>
    <div class="caixa">
      <table class="tabela">
        <thead><tr><th>Origem do ganho</th><th>Valor</th><th></th></tr></thead>
        <tbody id="abundancia"></tbody>
      </table>
      <button onclick="addLinha('abundancia','ganho')">+ adicionar ganho</button>
      <div class="total-secao">Total AbundÃ¢ncia: R$ <span id="total-abundancia">0</span></div>
    </div>

    <h2 style="margin-top:34px">âœ¦ Fluidez</h2>
    <div class="texto">Aqui vocÃª observa para onde sua energia financeira escoa â€” como vocÃª gasta, sustenta e nutre sua vida.</div>

    <h3>A) Sustento</h3><div class="texto">Despesas essenciais para sua sobrevivÃªncia material: moradia, contas, transporte, alimentaÃ§Ã£o.</div>
    <div class="caixa">
      <table class="tabela">
        <thead><tr><th>DescriÃ§Ã£o</th><th>Valor</th><th></th></tr></thead>
        <tbody id="sustento"></tbody>
      </table>
      <button onclick="addLinha('sustento')">+ adicionar gasto</button>
    </div>
<br> </br>
    <h3>B) Florescimento</h3><div class="texto">Gastos que ampliam prazer, aprendizado, descanso, cultura e bem-estar.</div>
    <div class="caixa">
      <table class="tabela">
        <thead><tr><th>DescriÃ§Ã£o</th><th>Valor</th><th></th></tr></thead>
        <tbody id="florescimento"></tbody>
      </table>
      <button onclick="addLinha('florescimento')">+ adicionar gasto</button>
    </div>
<br> </br>
    <h3>C) Centelha EnergÃ©tica</h3><div class="texto">Gastos inesperados ou emergenciais que exigem energia imediata.</div>
    <div class="caixa">
      <table class="tabela">
        <thead><tr><th>DescriÃ§Ã£o</th><th>Valor</th><th></th></tr></thead>
        <tbody id="centelha"></tbody>
      </table>
      <button onclick="addLinha('centelha')">+ adicionar gasto</button>
    </div>

    <h2 style="margin-top:34px">âœ¦ ExpansÃ£o</h2>
    <div class="texto">Reservas voltadas a investimentos futuros, sonhos, avanÃ§os e projetos de longo prazo.</div>
    <div class="caixa">
      <label>Sementes de Prosperidade</label>
      <input placeholder="Valor reservado">
      <label>Sonho ou intenÃ§Ã£o</label>
      <input placeholder="Liberdade, descanso, projeto...">
    </div>

        <div id="totais">
        <div class="total-secao">Total Sustento: R$ <span id="total-sustento">0</span></div>
        <div class="total-secao">Total Florescimento: R$ <span id="total-florescimento">0</span></div>
        <div class="total-secao">Total Centelha: R$ <span id="total-centelha">0</span></div>
        <div class="saldo">Saldo EnergÃ©tico do MÃªs: R$ <span id="saldo">0</span></div>
      </div>

  </section>

  <aside class="lateral">
    <section class="lunar">
      <h3>ğŸŒ™ A Lua Observa Teu Ouro</h3>
      <p><strong>Lua Nova:</strong> planeje, defina metas, evite impulsos.</p>
      <p><strong>Lua Crescente:</strong> organize, negocie, expanda.</p>
      <p><strong>Lua Cheia:</strong> agradeÃ§a, observe excessos.</p>
      <p><strong>Lua Minguante:</strong> corte gastos e libere padrÃµes.</p>
      <div class="grafico" id="grafico">ğŸ“Š GrÃ¡fico Ritual: Fluidez x Lua<br>(ativaÃ§Ã£o simbÃ³lica)</div>
    </section>
  </aside>

</main>

<script>
// ===== VARIÃVEIS GLOBAIS =====
let deferredPrompt = null;

// ===== ELEMENTOS =====
const installOverlay = document.getElementById('installOverlay');
const formOverlay = document.getElementById('formOverlay');
const btnInstalarPWA = document.getElementById('btnInstalarPWA');
const btnPularInstalacao = document.getElementById('btnPularInstalacao');
const btnInstalarAgora = document.getElementById('btnInstalarAgora');
const btnAlterarNome = document.getElementById('btnAlterarNome');
const btnConfigNotificacoes = document.getElementById('btnConfigNotificacoes');
const modalNotificacoes = document.getElementById('modalNotificacoes');
const btnFecharNotificacoes = document.getElementById('btnFecharNotificacoes');
const btnSalvarConfigNotificacoes = document.getElementById('btnSalvarConfigNotificacoes');
const capa = document.getElementById('capa');
const planner = document.getElementById('planner');
const prospera = document.getElementById('prospera');
const grid = document.getElementById('grid');
const mesTitulo = document.getElementById('mesTitulo');
const perfilEl = document.getElementById('perfil');
const nomeCapa = document.getElementById('nomeCapa');
const modal = document.getElementById('modal');
const oraculo = document.getElementById('oraculo');
const notasSalvas = document.getElementById('notasSalvas');
const sentimentosSalvos = document.getElementById('sentimentosSalvos');

let mesAtual = new Date().getMonth();
let anoAtual = 2026;
let diaAtual = null;

// ===== FUNÃ‡Ã•ES DE ARMAZENAMENTO =====
function save(k, v) {
  localStorage.setItem(k, JSON.stringify(v));
}

function load(k) {
  const v = localStorage.getItem(k);
  return v ? JSON.parse(v) : null;
}

// ===== FLUXO DE INSTALAÃ‡ÃƒO =====
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  if (btnInstalarAgora) {
    btnInstalarAgora.style.display = 'block';
  }
  
  const hasVisited = localStorage.getItem('hasVisited');
  if (!hasVisited) {
    installOverlay.style.display = 'flex';
    formOverlay.style.display = 'none';
  }
});

btnInstalarPWA.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  
  deferredPrompt.prompt();
  const choiceResult = await deferredPrompt.userChoice;
  
  if (choiceResult.outcome === 'accepted') {
    console.log('UsuÃ¡rio aceitou instalar o PWA');
  }
  
  deferredPrompt = null;
  installOverlay.style.display = 'none';
  formOverlay.style.display = 'flex';
  localStorage.setItem('hasVisited', 'true');
});

btnPularInstalacao.addEventListener('click', () => {
  installOverlay.style.display = 'none';
  formOverlay.style.display = 'flex';
  localStorage.setItem('hasVisited', 'true');
});

btnInstalarAgora.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  
  deferredPrompt.prompt();
  const choiceResult = await deferredPrompt.userChoice;
  
  if (choiceResult.outcome === 'accepted') {
    btnInstalarAgora.style.display = 'none';
  }
});

// ===== CONFIGURAÃ‡ÃƒO DE NOTIFICAÃ‡Ã•ES =====
btnConfigNotificacoes.addEventListener('click', () => {
  const config = load('configNotificacoes') || {
    ativas: 'sim',
    horaDiaria: '08:00',
    notificarSabas: 'sim',
    antecedenciaSabas: '1',
    horaSabas: '09:00'
  };
  
  document.getElementById('notificacoesAtivas').value = config.ativas;
  document.getElementById('horaNotificacaoDiaria').value = config.horaDiaria;
  document.getElementById('notificarSabas').value = config.notificarSabas;
  document.getElementById('antecedenciaSabas').value = config.antecedenciaSabas;
  document.getElementById('horaNotificacaoSabas').value = config.horaSabas;
  
  modalNotificacoes.style.display = 'flex';
});

btnFecharNotificacoes.addEventListener('click', () => {
  modalNotificacoes.style.display = 'none';
});

// ===== FUNÃ‡Ã•ES DE NOTIFICAÃ‡ÃƒO CORRIGIDAS =====
function solicitarPermissaoNotificacao() {
  if (!('Notification' in window)) {
    console.log('Este navegador nÃ£o suporta notificaÃ§Ãµes.');
    return;
  }
  
  if (Notification.permission === 'default') {
    Notification.requestPermission().then(permission => {
      if (permission === 'granted') {
        console.log('PermissÃ£o para notificaÃ§Ãµes concedida.');
        setTimeout(() => agendarNotificacoes(), 1000);
      }
    });
  }
}

function agendarNotificacoes() {
  const config = load('configNotificacoes');
  if (!config) return;

  const agora = new Date();

  // =========================
  // ğŸ”¥ PRÃ“XIMO SABÃ
  // =========================
  const proximoSaba = Object.entries(sabas2026)
    .map(([dataISO, saba]) => ({
      data: new Date(`${dataISO}T00:00:00`),
      saba
    }))
    .filter(e => e.data > agora)
    .sort((a, b) => a.data - b.data)[0];

  if (proximoSaba) {
    const antecedencia = parseInt(config.antecedenciaSabas);
    const alerta = new Date(proximoSaba.data);
    alerta.setDate(alerta.getDate() - antecedencia);

    const [h, m] = config.horaSabas.split(':').map(Number);
    alerta.setHours(h, m, 0, 0);

    if (alerta > agora) {
      setTimeout(() => {
        enviarNotificacao(
          `ğŸ”¥ SabÃ¡ se aproxima`,
          `Faltam ${antecedencia} dias para ${proximoSaba.saba.nome}.`
        );
      }, alerta - agora);
    }
  }

  // =========================
  // ğŸŒ™ PRÃ“XIMA LUA
  // =========================
  const proximaLua = Object.entries(lunacoes2026)
    .map(([dataISO, lua]) => ({
      data: new Date(`${dataISO}T${lua.hora || '09:00'}:00`),
      lua
    }))
    .filter(e => e.data > agora)
    .sort((a, b) => a.data - b.data)[0];

  if (proximaLua) {
    const alerta24h = new Date(proximaLua.data.getTime() - 86400000);

    if (alerta24h > agora) {
      setTimeout(() => {
        enviarNotificacao(
          `ğŸŒ™ AmanhÃ£: ${proximaLua.lua.fase}`,
          `Lua em ${proximaLua.lua.signo}.`
        );
      }, alerta24h - agora);
    }

    setTimeout(() => {
      enviarNotificacao(
        `ğŸŒ™ Lua em transiÃ§Ã£o`,
        `${proximaLua.lua.fase} em ${proximaLua.lua.signo} agora.`
      );
    }, proximaLua.data - agora);
  }
}

function agendarNotificacaoDiaria(config) {
  console.log('Agendando notificaÃ§Ã£o diÃ¡ria...');
  
  // Usar hora configurada pelo usuÃ¡rio
  const [hora, minuto] = config.horaDiaria.split(':').map(Number);
  const agora = new Date();
  const hojeNotificacao = new Date(
    agora.getFullYear(),
    agora.getMonth(),
    agora.getDate(),
    hora,
    minuto
  );
  
  // Se jÃ¡ passou da hora hoje, agenda para amanhÃ£
  if (agora >= hojeNotificacao) {
    hojeNotificacao.setDate(hojeNotificacao.getDate() + 1);
  }
  
  const diferencaMs = hojeNotificacao - agora;
  
  setTimeout(() => {
    enviarNotificacaoDiaria();
    // Reagendar para o prÃ³ximo dia
    agendarNotificacaoDiaria(config);
  }, diferencaMs);
}

function enviarNotificacaoDiaria() {
  if (Notification.permission !== 'granted') return;
  
  const hoje = new Date().toISOString().split('T')[0];
  const notas = load('notas') || {};
  const temNotas = Array.isArray(notas[hoje]) && notas[hoje].length > 0;
  
  let corpo = 'âœ¨ Lembre-se de registrar seus pensamentos e sentimentos hoje.';
  
  if (temNotas) {
    corpo = 'ğŸ“– VocÃª tem notas registradas para hoje. Reveja-as para reflexÃ£o.';
  }
  
  const sabaHoje = sabas2026[hoje];
  if (sabaHoje) {
    corpo += `\n\nğŸ”¥ ALERTA: Hoje Ã© ${sabaHoje.nome}: ${sabaHoje.significado}`;
  }
  
  const luaHoje = lunacoes2026[hoje];
  if (luaHoje) {
    corpo += `\n\nğŸŒ™ ALERTA: ${luaHoje.fase} em ${luaHoje.signo} hoje.`;
  }
  
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.ready.then(reg => {
      reg.showNotification('ğŸŒ™ GrimÃ³rio RitualÃ­stico - DiÃ¡rio', {
        body: corpo,
        icon: 'icon-192.png',
        tag: 'diario-' + new Date().toISOString().split('T')[0]
      });
    }).catch(err => {
      console.error('Erro:', err);
      new Notification('ğŸŒ™ GrimÃ³rio RitualÃ­stico - DiÃ¡rio', {
        body: corpo,
        icon: 'icon-192.png'
      });
    });
  } else {
    new Notification('ğŸŒ™ GrimÃ³rio RitualÃ­stico - DiÃ¡rio', {
      body: corpo,
      icon: 'icon-192.png'
    });
  }
}

// FUNÃ‡ÃƒO CORRIGIDA - SabÃ¡s sÃ³ nas datas especÃ­ficas
function agendarNotificacoesSabas(config) {
  console.log('Agendando notificaÃ§Ãµes de SabÃ¡s...');
  
  const antecedencia = parseInt(config.antecedenciaSabas);
  const hoje = new Date();
  
  Object.keys(sabas2026).forEach(dataSabÃ¡ => {
    const dataSabÃ¡Obj = new Date(dataSabÃ¡ + 'T00:00:00');
    const sabÃ¡ = sabas2026[dataSabÃ¡];
    
    // Calcular data da notificaÃ§Ã£o (data do SabÃ¡ - antecedÃªncia)
    const dataNotificacao = new Date(dataSabÃ¡Obj);
    dataNotificacao.setDate(dataNotificacao.getDate() - antecedencia);
    
    // Se jÃ¡ passou da data de notificaÃ§Ã£o, nÃ£o agendar
    if (dataNotificacao < hoje) {
      return;
    }
    
    // Agendar para a hora configurada
    const [hora, minuto] = config.horaSabas.split(':').map(Number);
    dataNotificacao.setHours(hora, minuto, 0, 0);
    
    // Se jÃ¡ passou da hora hoje, verificar se Ã© hoje o SabÃ¡
    if (dataNotificacao < hoje) {
      // Verificar se hoje Ã© o dia do SabÃ¡
      if (dataSabÃ¡Obj.toISOString().split('T')[0] === hoje.toISOString().split('T')[0]) {
        // Notificar hoje mesmo
        dataNotificacao.setTime(hoje.getTime() + 30000); // 30 segundos para teste
      } else {
        return; // JÃ¡ passou a data de notificaÃ§Ã£o
      }
    }
    
    const diferencaMs = dataNotificacao - hoje;
    
    setTimeout(() => {
      enviarNotificacaoSabÃ¡(sabÃ¡, antecedencia);
    }, diferencaMs);
  });
}

function enviarNotificacaoSabÃ¡(sabÃ¡, antecedencia) {
  if (Notification.permission !== 'granted') return;
  
  let mensagem = '';
  let titulo = '';
  
  if (antecedencia === 0) {
    titulo = `ğŸ”¥ ALERTA: ${sabÃ¡.nome} HOJE!`;
    mensagem = `Hoje Ã© ${sabÃ¡.nome} (${sabÃ¡.tipo}). ${sabÃ¡.significado}`;
  } else {
    titulo = `ğŸ”¥ ALERTA: ${sabÃ¡.nome} em ${antecedencia} dia(s)`;
    mensagem = `Em ${antecedencia} dia(s) serÃ¡ ${sabÃ¡.nome}. ${sabÃ¡.significado}`;
  }
  
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.ready.then(reg => {
      reg.showNotification(titulo, {
        body: mensagem,
        icon: 'icon-192.png',
        tag: `saba-${sabÃ¡.nome}-${antecedencia}`
      });
    });
  } else {
    new Notification(titulo, {
      body: mensagem,
      icon: 'icon-192.png'
    });
  }
}

// NOVAS FUNÃ‡Ã•ES PARA NOTIFICAÃ‡Ã•ES LUNARES
function agendarNotificacoesLunares() {
  console.log('Agendando notificaÃ§Ãµes lunares...');
  
  const hoje = new Date();
  
  Object.keys(lunacoes2026).forEach(dataLua => {
    const dataLuaObj = new Date(dataLua + 'T00:00:00');
    const lua = lunacoes2026[dataLua];
    
    // Notificar no prÃ³prio dia da fase lunar
    if (dataLuaObj.toISOString().split('T')[0] === hoje.toISOString().split('T')[0]) {
      // Agendar para 8:00 da manhÃ£
      const dataNotificacao = new Date(dataLuaObj);
      dataNotificacao.setHours(8, 0, 0, 0);
      
      // Se jÃ¡ passou das 8h, notificar em 30 segundos (para teste)
      if (dataNotificacao < hoje) {
        dataNotificacao.setTime(hoje.getTime() + 30000);
      }
      
      const diferencaMs = dataNotificacao - hoje;
      
      setTimeout(() => {
        enviarNotificacaoLunar(lua);
      }, diferencaMs);
    }
  });
}

function enviarNotificacaoLunar(lua) {
  if (Notification.permission !== 'granted') return;
  
  const titulo = `ğŸŒ™ ALERTA: ${lua.fase} em ${lua.signo}`;
  const mensagem = `Hoje temos ${lua.fase.toLowerCase()} em ${lua.signo}. `;
  
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.ready.then(reg => {
      reg.showNotification(titulo, {
        body: mensagem + 'Aproveite essa energia!',
        icon: 'icon-192.png',
        tag: `lua-${lua.fase}-${new Date().toISOString().split('T')[0]}`
      });
    });
  } else {
    new Notification(titulo, {
      body: mensagem + 'Aproveite essa energia!',
      icon: 'icon-192.png'
    });
  }
}

// FUNÃ‡ÃƒO NOVA - ADICIONADA
function enviarNotificacaoNota(textoNota, horaNota, notificacaoId = '', dataISO = '') {
  console.log('ğŸ“ Tentando enviar notificaÃ§Ã£o de lembrete...');
  
  if (Notification.permission !== 'granted') {
    console.warn('âŒ PermissÃ£o de notificaÃ§Ã£o nÃ£o concedida');
    return;
  }
  
  const preview = textoNota.length > 50 ? textoNota.substring(0, 50) + '...' : textoNota;
  const titulo = `ğŸ“ LEMBRETE: ${horaNota}`;
  
  console.log(`ğŸ“‹ Detalhes: "${preview}" para ${horaNota}`);
  
  // Tentar via Service Worker primeiro
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    console.log('ğŸš€ Usando Service Worker para notificaÃ§Ã£o...');
    
    navigator.serviceWorker.ready
      .then(reg => {
        console.log('âœ… Service Worker pronto');
        
        const options = {
          body: preview,
          icon: 'icon-192.png',
          badge: 'icon-192.png',
          tag: notificacaoId || `lembrete-${Date.now()}`,
          timestamp: Date.now(),
          vibrate: [200, 100, 200],
          requireInteraction: true, // MantÃ©m notificaÃ§Ã£o visÃ­vel
          data: {
            url: window.location.href,
            type: 'lembrete',
            dataISO: dataISO || new Date().toISOString().split('T')[0],
            hora: horaNota
          }
        };
        
        return reg.showNotification(titulo, options);
      })
      .then(() => {
        console.log('âœ… NotificaÃ§Ã£o de lembrete enviada via Service Worker!');
      })
      .catch(err => {
        console.error('âŒ Erro no Service Worker:', err);
        // Fallback para API tradicional
        fallbackNotification();
      });
  } else {
    console.log('âš ï¸ Service Worker nÃ£o disponÃ­vel, usando fallback');
    fallbackNotification();
  }
  
  // FunÃ§Ã£o de fallback
  function fallbackNotification() {
    try {
      const notification = new Notification(titulo, {
        body: preview,
        icon: 'icon-192.png',
        tag: notificacaoId || `lembrete-${Date.now()}`
      });
      
      notification.onclick = function() {
        window.focus();
        this.close();
      };
      
      console.log('âœ… NotificaÃ§Ã£o enviada (fallback)');
    } catch (err) {
      console.error('âŒ Erro ao criar notificaÃ§Ã£o:', err);
      // Ãšltimo recurso: alert
      alert(`â° Lembrete: ${horaNota}\n${preview}`);
    }
  }
}

// FUNÃ‡ÃƒO ATUALIZADA PARA AGENDAR NOTIFICAÃ‡Ã•ES DE NOTAS
function agendarNotificacaoNota(dataISO, horaNota, antecedenciaMinutos, textoNota) {
  console.log('â° AGENDANDO NOTIFICAÃ‡ÃƒO DE NOTA');
  console.log('ğŸ“… Data:', dataISO);
  console.log('ğŸ• Hora:', horaNota);
  console.log('â±ï¸ AntecedÃªncia:', antecedenciaMinutos, 'minutos');
  console.log('ğŸ“ Texto:', textoNota.substring(0, 30) + '...');
  
  try {
    // Validar dados
    if (!horaNota || !textoNota) {
      console.error('âŒ Dados incompletos para agendar notificaÃ§Ã£o');
      return;
    }
    
    // Parse da hora
    const [horas, minutos] = horaNota.split(':').map(Number);
    if (isNaN(horas) || isNaN(minutos)) {
      console.error('âŒ Formato de hora invÃ¡lido:', horaNota);
      return;
    }
    
    // Calcular data/hora da notificaÃ§Ã£o
    const dataNota = new Date(dataISO + 'T00:00:00');
    dataNota.setHours(horas, minutos, 0, 0);
    
    // Aplicar antecedÃªncia (em milissegundos)
    const antecedenciaMs = antecedenciaMinutos * 60 * 1000;
    const dataNotificacao = new Date(dataNota.getTime() - antecedenciaMs);
    
    const agora = new Date();
    const diferencaMs = dataNotificacao - agora;
    
    console.log('ğŸ“Š CÃ¡lculos:');
    console.log('   Data da nota:', dataNota.toLocaleString());
    console.log('   Data notificaÃ§Ã£o:', dataNotificacao.toLocaleString());
    console.log('   Agora:', agora.toLocaleString());
    console.log('   DiferenÃ§a (ms):', diferencaMs);
    
    // Salvar no localStorage para persistÃªncia
    const notificacoesAgendadas = load('notificacoesAgendadas') || [];
    const notificacaoId = `nota-${dataISO}-${horaNota}-${Date.now()}`;
    
    notificacoesAgendadas.push({
      id: notificacaoId,
      dataISO: dataISO,
      horaNota: horaNota,
      dataNotificacao: dataNotificacao.toISOString(),
      texto: textoNota,
      antecedencia: antecedenciaMinutos,
      criadoEm: new Date().toISOString(),
      status: 'agendado'
    });
    
    save('notificacoesAgendadas', notificacoesAgendadas);
    console.log('ğŸ’¾ NotificaÃ§Ã£o salva no localStorage');
    
    // Agendar timeout apenas se for no futuro
    if (diferencaMs > 0) {
      console.log('â° Agendando timeout para', diferencaMs, 'ms');
      
      setTimeout(() => {
        console.log('ğŸ”” HORA DA NOTIFICAÃ‡ÃƒO!');
        enviarNotificacaoNota(textoNota, horaNota, notificacaoId, dataISO);
        
        // Marcar como enviada
        const notifs = load('notificacoesAgendadas') || [];
        const index = notifs.findIndex(n => n.id === notificacaoId);
        if (index !== -1) {
          notifs[index].status = 'enviado';
          notifs[index].enviadoEm = new Date().toISOString();
          save('notificacoesAgendadas', notifs);
        }
      }, diferencaMs);
      
      // Para teste: tambÃ©m agendar uma notificaÃ§Ã£o em 10 segundos
      if (diferencaMs > 10000) { // Se a notificaÃ§Ã£o real for mais de 10 segundos no futuro
        console.log('ğŸ§ª Agendando notificaÃ§Ã£o de teste em 10 segundos');
        setTimeout(() => {
          enviarNotificacaoNota("[TESTE] " + textoNota, horaNota, notificacaoId + "-teste", dataISO);
        }, 10000);
      }
      
    } else {
      console.warn('âš ï¸ Data/hora jÃ¡ passou. Enviando imediatamente...');
      enviarNotificacaoNota(textoNota, horaNota, notificacaoId, dataISO);
    }
    
  } catch (error) {
    console.error('âŒ ERRO ao agendar notificaÃ§Ã£o:', error);
    console.error('Stack:', error.stack);
  }
}

// FUNÃ‡ÃƒO PARA AGENDAR NOTIFICAÃ‡Ã•ES DE NOTAS EXISTENTES
function agendarNotificacoesNotas() {
  const notasComNotificacao = load('notasComNotificacao') || {};
  const hoje = new Date();
  
  Object.keys(notasComNotificacao).forEach(dataISO => {
    const notificacoes = notasComNotificacao[dataISO];
    
    notificacoes.forEach((notificacao, index) => {
      const { horaNota, antecedencia, texto } = notificacao;
      const [hora, minuto] = horaNota.split(':').map(Number);
      
      const dataNota = new Date(dataISO + 'T00:00:00');
      dataNota.setHours(hora, minuto, 0, 0);
      
      // Ajustar pela antecedÃªncia (em minutos)
      const dataNotificacao = new Date(dataNota.getTime() - (antecedencia * 60000));
      
      // Se jÃ¡ passou, nÃ£o agendar
      if (dataNotificacao < hoje) {
        notasComNotificacao[dataISO].splice(index, 1);
        return;
      }
      
      const diferencaMs = dataNotificacao - hoje;
      
      setTimeout(() => {
        enviarNotificacaoNota(texto, horaNota);
        
        // Remover da lista apÃ³s enviar
        notasComNotificacao[dataISO].splice(index, 1);
        if (notasComNotificacao[dataISO].length === 0) {
          delete notasComNotificacao[dataISO];
        }
        save('notasComNotificacao', notasComNotificacao);
      }, diferencaMs);
    });
  });
}

// FUNÃ‡ÃƒO PARA VERIFICAR NOTIFICAÃ‡Ã•ES PENDENTES
function verificarNotificacoesPendentes() {
  console.log('ğŸ” Verificando notificaÃ§Ãµes pendentes...');
  
  const notificacoes = load('notificacoesAgendadas') || [];
  const agora = new Date();
  
  notificacoes.forEach((notif, index) => {
    if (notif.status === 'agendado') {
      const dataNotif = new Date(notif.dataNotificacao);
      
      if (dataNotif <= agora) {
        console.log('â° NotificaÃ§Ã£o vencida, enviando agora:', notif.id);
        enviarNotificacaoNota(notif.texto, notif.horaNota, notif.id, notif.dataISO);
        
        // Atualizar status
        notificacoes[index].status = 'enviado';
        notificacoes[index].enviadoEm = new Date().toISOString();
      }
    }
  });
  
  save('notificacoesAgendadas', notificacoes);
  
  // Manter apenas notificaÃ§Ãµes dos Ãºltimos 7 dias
  const umaSemanaAtras = new Date(agora.getTime() - 7 * 24 * 60 * 60 * 1000);
  const notificacoesFiltradas = notificacoes.filter(notif => {
    const dataCriacao = new Date(notif.criadoEm);
    return dataCriacao >= umaSemanaAtras;
  });
  
  if (notificacoesFiltradas.length < notificacoes.length) {
    save('notificacoesAgendadas', notificacoesFiltradas);
    console.log('ğŸ§¹ NotificaÃ§Ãµes antigas limpas');
  }
}

// ===== BOTÃƒO SALVAR CONFIGURAÃ‡Ã•ES ATUALIZADO =====
btnSalvarConfigNotificacoes.addEventListener('click', async () => {
  try {
    const config = {
      ativas: document.getElementById('notificacoesAtivas').value,
      horaDiaria: document.getElementById('horaNotificacaoDiaria').value,
      notificarSabas: document.getElementById('notificarSabas').value,
      antecedenciaSabas: document.getElementById('antecedenciaSabas').value,
      horaSabas: document.getElementById('horaNotificacaoSabas').value
    };
    
    console.log('Salvando configuraÃ§Ãµes:', config);
    save('configNotificacoes', config);
    
    // Solicitar permissÃ£o se ainda nÃ£o tiver
    if (Notification.permission === 'default') {
      const permission = await Notification.requestPermission();
      if (permission !== 'granted') {
        alert('âŒ NotificaÃ§Ãµes nÃ£o permitidas. Ative as permissÃµes no navegador.');
        return;
      }
    }
    
    // Parar todas as notificaÃ§Ãµes atuais
    if ('serviceWorker' in navigator) {
      try {
        const registration = await navigator.serviceWorker.ready;
        const notifications = await registration.getNotifications();
        notifications.forEach(notification => notification.close());
        console.log('NotificaÃ§Ãµes anteriores fechadas:', notifications.length);
      } catch (swError) {
        console.warn('Erro ao acessar Service Worker:', swError);
      }
    }
    
    // Reagendar com novas configuraÃ§Ãµes
    setTimeout(() => {
      agendarNotificacoes();
    }, 1000);
    
    modalNotificacoes.style.display = 'none';
    
    // Mostrar mensagem de sucesso
    const mensagem = document.createElement('div');
    mensagem.innerHTML = 'âœ… <strong>ConfiguraÃ§Ãµes salvas!</strong><br>NotificaÃ§Ãµes foram reagendadas.';
    mensagem.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--color-transformative-teal);
      color: white;
      padding: 15px;
      border-radius: 8px;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      animation: slideIn 0.3s ease;
    `;
    document.body.appendChild(mensagem);
    
    setTimeout(() => {
      mensagem.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => document.body.removeChild(mensagem), 300);
    }, 3000);
    
  } catch (error) {
    console.error('Erro ao salvar configuraÃ§Ãµes:', error);
    alert('âŒ Erro ao salvar configuraÃ§Ãµes: ' + error.message);
  }
});

// Adicionar estilos de animaÃ§Ã£o
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(style);

// ===== FORMULÃRIO =====
document.getElementById('salvar').onclick = () => {
  const nome = document.getElementById('nome').value.trim();
  const signo = document.getElementById('signo').value;
  const ano = document.getElementById('anoPessoal').value;
  const dataNascimento = document.getElementById('dataNascimento').value;
  const ciclo = document.getElementById('ciclo').value;

  if (!nome) {
    alert('Por favor, digite seu nome mÃ¡gico!');
    return;
  }

  if (!signo) {
    alert('Por favor, selecione seu signo!');
    return;
  }

  const perfil = {
    nome: nome,
    signo: signo,
    ano: ano || '',
    dataNascimento: dataNascimento || '',
    ciclo: ciclo || ''
  };

  save('perfil', perfil);
  solicitarPermissaoNotificacao();
  nomeCapa.textContent = `Salve, ${perfil.nome}`;
  formOverlay.style.display = 'none';
  capa.style.display = 'block';
  localStorage.setItem('formPreenchido', 'true');
  
  const configNotificacoes = load('configNotificacoes');
  if (!configNotificacoes) {
    save('configNotificacoes', {
      ativas: 'sim',
      horaDiaria: '08:00',
      notificarSabas: 'sim',
      antecedenciaSabas: '1',
      horaSabas: '09:00'
    });
  }
};

btnAlterarNome.addEventListener('click', () => {
  const perfilAtual = load('perfil') || {};
  document.getElementById('nome').value = perfilAtual.nome || '';
  document.getElementById('signo').value = perfilAtual.signo || '';
  document.getElementById('anoPessoal').value = perfilAtual.ano || '';
  document.getElementById('dataNascimento').value = perfilAtual.dataNascimento || '';
  document.getElementById('ciclo').value = perfilAtual.ciclo || '';
  capa.style.display = 'none';
  formOverlay.style.display = 'flex';
});

// ===== VERIFICAÃ‡ÃƒO INICIAL =====
window.addEventListener('load', () => {
  const perfilSalvo = load('perfil');
  
  if (perfilSalvo && perfilSalvo.nome) {
    formOverlay.style.display = 'none';
    capa.style.display = 'block';
    nomeCapa.textContent = `Salve, ${perfilSalvo.nome} âœ¨`;
  } else {
    const hasVisited = localStorage.getItem('hasVisited');
    if (!hasVisited && deferredPrompt) {
      installOverlay.style.display = 'flex';
      formOverlay.style.display = 'none';
    }
  }
  
  // Registrar Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(registration => {
        console.log('Service Worker registrado:', registration.scope);
      })
      .catch(err => {
        console.error('Erro no Service Worker:', err);
      });
  }
  
  // Agendar notificaÃ§Ãµes apÃ³s carregar
  setTimeout(() => {
    agendarNotificacoes();
  }, 2000);
  
  // Verificar notificaÃ§Ãµes pendentes ao carregar
  setTimeout(() => {
    verificarNotificacoesPendentes();
    
    // Verificar a cada minuto
    setInterval(verificarNotificacoesPendentes, 60000);
  }, 3000);
});

// ===== DADOS DAS PLANILHAS =====
const sabas2026 = {
  '2026-02-01': {
    nome: 'Lughnasadh',
    tipo: 'SabÃ¡ Maior',
    estacaoElemento: 'VerÃ£o/Fogo',
    significado: 'Primeira colheita',
    rituais: 'Assar pÃ£es caseiros e bolos de grÃ£os, expressar gratidÃ£o pela fartura, agradecer pelos frutos jÃ¡ colhidos, ritual de colheita e prosperidade'
  },
  '2026-03-20': {
    nome: 'Mabon',
    tipo: 'SabÃ¡ Menor',
    estacaoElemento: 'Outono/Ãgua',
    significado: 'EquilÃ­brio e colheita completa',
    rituais: 'Oferendas de maÃ§Ã£s e frutas da estaÃ§Ã£o, compartilhamento de banquetes, agradecimento pela colheita, preparaÃ§Ã£o para o recolhimento do inverno, rituais de equilÃ­brio e gratidÃ£o'
  },
  '2026-05-01': {
    nome: 'Samhain',
    tipo: 'SabÃ¡ Maior',
    estacaoElemento: 'Outono/Terra',
    significado: 'Ano Novo PagÃ£o, Festival dos Mortos',
    rituais: 'Honrar ancestrais e entes queridos falecidos, limpeza de altares e espaÃ§os sagrados, queima de pedidos ou banimentos, conexÃ£o com o mundo espiritual, divinaÃ§Ã£o e introspecÃ§Ã£o'
  },
  '2026-06-21': {
    nome: 'Yule',
    tipo: 'SabÃ¡ Menor',
    estacaoElemento: 'Inverno/Fogo',
    significado: 'SolstÃ­cio de Inverno, Renascimento',
    rituais: 'Acendimento da "tora de Yule" ou velas, decoraÃ§Ã£o de Ã¡rvores com sÃ­mbolos de vida eterna, rituais para atrair a luz de volta, celebraÃ§Ã£o do renascimento do sol, troca de presentes simbÃ³licos'
  },
  '2026-08-01': {
    nome: 'Imbolc',
    tipo: 'SabÃ¡ Maior',
    estacaoElemento: 'Inverno/Ãgua',
    significado: 'PurificaÃ§Ã£o e proteÃ§Ã£o',
    rituais: 'Acender muitas velas (fogo da inspiraÃ§Ã£o), dedicaÃ§Ã£o Ã  deusa BrÃ­gida, limpezas energÃ©ticas na casa, rituais de purificaÃ§Ã£o e proteÃ§Ã£o, preparaÃ§Ã£o para o retorno da luz'
  },
  '2026-09-22': {
    nome: 'Ostara',
    tipo: 'SabÃ¡ Menor',
    estacaoElemento: 'Primavera/Ar',
    significado: 'EquinÃ³cio de Primavera, Fertilidade',
    rituais: 'Plantio de sementes fÃ­sicas ou projetos, decoraÃ§Ã£o de ovos (sÃ­mbolo de potencial), rituais de fertilidade e renovaÃ§Ã£o, celebraÃ§Ã£o do despertar da vida, equilÃ­brio entre luz e escuridÃ£o'
  },
  '2026-10-31': {
    nome: 'Beltane',
    tipo: 'SabÃ¡ Maior',
    estacaoElemento: 'Primavera/Fogo',
    significado: 'UniÃ£o, paixÃ£o e fertilidade mÃ¡xima',
    rituais: 'DanÃ§ar ao redor do "mastro de maio" (Maypole), acender fogueiras de proteÃ§Ã£o, celebrar o amor e a beleza da natureza, rituais de uniÃ£o e fertilidade, coroas de flores e decoraÃ§Ãµes naturais'
  },
  '2026-12-21': {
    nome: 'Litha',
    tipo: 'SabÃ¡ Menor',
    estacaoElemento: 'VerÃ£o/Fogo',
    significado: 'SolstÃ­cio de VerÃ£o, Poder Solar',
    rituais: 'Rituais ao ar livre para absorver energia solar, colheita de ervas mÃ¡gicas no auge do poder, celebraÃ§Ã£o da vitalidade com mÃºsica e danÃ§a, fogueiras e celebraÃ§Ãµes comunitÃ¡rias, honrar o Ã¡pice da luz'
  }
};

const energiasLunares = {
  'Lua Nova': {
    energiaPrincipal: 'IntrospecÃ§Ã£o, recomeÃ§o, potencial latente',
    acoesPositivas: 'Plantar novas intenÃ§Ãµes e iniciar projetos, fazer planos e definir metas, meditar e se conectar consigo mesmo, rituais de manifestaÃ§Ã£o',
    evitar: 'AÃ§Ãµes impulsivas sem planejamento, tomar decisÃµes importantes sem reflexÃ£o, forÃ§ar resultados imediatos'
  },
  'Lua Crescente': {
    energiaPrincipal: 'Crescimento, movimento, construÃ§Ã£o',
    acoesPositivas: 'Desenvolver projetos iniciados na Lua Nova, fazer reuniÃµes e networking, comeÃ§ar hÃ¡bitos novos, investir em relacionamentos, estudar e aprender',
    evitar: 'Abandonar compromissos no meio do caminho, dispersar energia em muitas direÃ§Ãµes, desistir diante de obstÃ¡culos'
  },
  'Lua Cheia': {
    energiaPrincipal: 'IluminaÃ§Ã£o, culminaÃ§Ã£o, revelaÃ§Ã£o',
    acoesPositivas: 'Colher resultados e celebrar conquistas, ter clareza sobre situaÃ§Ãµes, expressar emoÃ§Ãµes de forma saudÃ¡vel, finalizar projetos, rituais de gratidÃ£o',
    evitar: 'DecisÃµes impulsivas baseadas em emoÃ§Ãµes intensas, confrontos desnecessÃ¡rios, ignorar o que estÃ¡ sendo revelado'
  },
  'Lua Minguante': {
    energiaPrincipal: 'Desapego, encerramento, limpeza',
    acoesPositivas: 'Liberar o que nÃ£o serve mais, encerrar ciclos e relaÃ§Ãµes tÃ³xicas, fazer limpeza fÃ­sica e energÃ©tica, descansar e se recolher, prÃ¡ticas de desapego',
    evitar: 'Iniciar novos projetos ou relacionamentos, forÃ§ar aÃ§Ã£o quando o corpo pede descanso, ignorar sinais de que algo precisa terminar'
  }
};

const energiaSignoLunar = {
  'Ãries': {
    'Lua Nova': 'Momento de mÃ¡xima coragem para iniciar projetos pessoais e retomar o protagonismo.',
    'Lua Crescente': 'Impulso para agir rÃ¡pido e superar obstÃ¡culos com determinaÃ§Ã£o.',
    'Lua Cheia': 'Auge da autoconfianÃ§a; os desejos individuais entram em conflito ou equilÃ­brio com as necessidades dos outros.',
    'Lua Minguante': 'Necessidade de controlar a impaciÃªncia e revisar impulsos agressivos antes de encerrar o ciclo.'
  },
  'Touro': {
    'Lua Nova': 'Plantio focado em estabilidade financeira, conforto e seguranÃ§a material.',
    'Lua Crescente': 'PerÃ­odo de nutriÃ§Ã£o e paciÃªncia; foco em fazer as ideias "ganharem corpo" e raÃ­zes.',
    'Lua Cheia': 'Colheita de resultados concretos; momento de valorizar o prazer e o que foi construÃ­do.',
    'Lua Minguante': 'Hora de praticar o desapego material e emocional para evitar acÃºmulos desnecessÃ¡rios.'
  },
  'GÃªmeos': {
    'Lua Nova': 'InÃ­cio de novos estudos, contatos e circulaÃ§Ã£o de ideias.',
    'Lua Crescente': 'Fase de muita comunicaÃ§Ã£o, trocas intelectuais e busca por informaÃ§Ãµes.',
    'Lua Cheia': 'Clareza mental e revelaÃ§Ãµes; pensamentos que estavam nublados tornam-se objetivos.',
    'Lua Minguante': 'Momento de silenciar a mente, filtrar o excesso de informaÃ§Ã£o e concluir conversas pendentes.'
  },
  'CÃ¢ncer': {
    'Lua Nova': 'Foco total na renovaÃ§Ã£o da vida Ã­ntima, lar e famÃ­lia.',
    'Lua Crescente': 'IntensificaÃ§Ã£o das emoÃ§Ãµes, proteÃ§Ã£o de quem se ama e fortalecimento de vÃ­nculos.',
    'Lua Cheia': 'Transbordamento emocional e sensibilidade mÃ¡xima; colheita ligada ao acolhimento.',
    'Lua Minguante': 'Convite para olhar para dentro, perdoar o passado e buscar paz com a prÃ³pria histÃ³ria.'
  },
  'LeÃ£o': {
    'Lua Nova': 'Novos comeÃ§os ligados Ã  autoexpressÃ£o, criatividade e prazer.',
    'Lua Crescente': 'Desenvolvimento do carisma e esforÃ§o para ser notado em projetos autorais.',
    'Lua Cheia': 'CelebraÃ§Ã£o da identidade; momento de brilho pÃºblico e reconhecimento.',
    'Lua Minguante': 'ReflexÃ£o sobre o excesso de ego e recolhimento para restaurar a energia vital.'
  },
  'Virgem': {
    'Lua Nova': 'Planejamento de rotinas saudÃ¡veis e organizaÃ§Ã£o meticulosa de tarefas.',
    'Lua Crescente': 'Trabalho detalhista e ajustes prÃ¡ticos para garantir que os planos funcionem.',
    'Lua Cheia': 'Resultados visÃ­veis na saÃºde e no trabalho; clareza sobre o que precisa de melhoria tÃ©cnica.',
    'Lua Minguante': 'Faxina fÃ­sica e mental; momento de eliminar mÃ©todos ou hÃ¡bitos que nÃ£o servem mais.'
  },
  'Libra': {
    'Lua Nova': 'IntenÃ§Ãµes voltadas para parcerias, acordos e harmonia estÃ©tica.',
    'Lua Crescente': 'EsforÃ§o para equilibrar relaÃ§Ãµes e mediaÃ§Ã£o de conflitos em andamento.',
    'Lua Cheia': 'Auge dos relacionamentos; situaÃ§Ãµes sociais ou romÃ¢nticas chegam ao ponto crÃ­tico ou de Ã¡pice.',
    'Lua Minguante': 'AvaliaÃ§Ã£o da justiÃ§a nas trocas e finalizaÃ§Ã£o de compromissos que nÃ£o tÃªm reciprocidade.'
  },
  'EscorpiÃ£o': {
    'Lua Nova': 'Mergulho profundo em transformaÃ§Ãµes internas e novos investimentos emocionais ou financeiros.',
    'Lua Crescente': 'Fase de regeneraÃ§Ã£o e persistÃªncia emocional intensa diante de crises.',
    'Lua Cheia': 'RevelaÃ§Ãµes de segredos ou emoÃ§Ãµes ocultas; momento de purgaÃ§Ã£o e intensidade sexual.',
    'Lua Minguante': 'Desapego de traumas e limpeza de energias tÃ³xicas acumuladas.'
  },
  'SagitÃ¡rio': {
    'Lua Nova': 'Novos horizontes, viagens ou estudos superiores; busca por novos sentidos de vida.',
    'Lua Crescente': 'ExpansÃ£o de ideias e otimismo para seguir em frente com grandes planos.',
    'Lua Cheia': 'CulminaÃ§Ã£o de aventuras ou processos acadÃªmicos; celebraÃ§Ã£o da liberdade conquistada.',
    'Lua Minguante': 'ReflexÃ£o sobre a verdade e revisÃ£o de crenÃ§as antes de iniciar uma nova busca.'
  },
  'CapricÃ³rnio': {
    'Lua Nova': 'Metas de longo prazo, carreira e construÃ§Ã£o de autoridade.',
    'Lua Crescente': 'Disciplina rÃ­gida e superaÃ§Ã£o de obstÃ¡culos estruturais para subir na vida.',
    'Lua Cheia': 'Reconhecimento profissional e social; colheita do esforÃ§o e da perseveranÃ§a.',
    'Lua Minguante': 'RevisÃ£o de responsabilidades e encerramento de cargos ou projetos que jÃ¡ cumpriram seu tempo.'
  },
  'AquÃ¡rio': {
    'Lua Nova': 'Ideias inovadoras, projetos coletivos e foco em causas sociais ou tecnolÃ³gicas.',
    'Lua Crescente': 'MovimentaÃ§Ã£o em grupos e colaboraÃ§Ã£o para ver mudanÃ§as acontecerem.',
    'Lua Cheia': 'Resultados de movimentos sociais ou amizades; clareza sobre o papel do indivÃ­duo no coletivo.',
    'Lua Minguante': 'AvaliaÃ§Ã£o da prÃ³pria liberdade e distanciamento de cÃ­rculos sociais que limitam a autenticidade.'
  },
  'Peixes': {
    'Lua Nova': 'InÃ­cio de ciclos espirituais, artÃ­sticos ou de cura emocional profunda.',
    'Lua Crescente': 'Sensibilidade aguÃ§ada e desenvolvimento da intuiÃ§Ã£o para guiar as aÃ§Ãµes.',
    'Lua Cheia': 'Auge da imaginaÃ§Ã£o e conexÃ£o com o divino; sonhos que se tornam nÃ­tidos ou se realizam.',
    'Lua Minguante': 'Entrega, dissoluÃ§Ã£o de ilusÃµes e preparaÃ§Ã£o espiritual para o renascimento.'
  }
};

const energiaNumerologia = {
  1: { potencial: 'InÃ­cio, lideranÃ§a, independÃªncia', risco: 'EgoÃ­smo, impulsividade' },
  2: { potencial: 'CooperaÃ§Ã£o, diplomacia, sensibilidade', risco: 'IndecisÃ£o, dependÃªncia emocional' },
  3: { potencial: 'Criatividade, expressÃ£o, alegria', risco: 'Superficialidade, dispersÃ£o' },
  4: { potencial: 'Estabilidade, organizaÃ§Ã£o, trabalho', risco: 'Rigidez, resistÃªncia Ã  mudanÃ§a' },
  5: { potencial: 'Liberdade, mudanÃ§a, aventura', risco: 'InconstÃ¢ncia, irresponsabilidade' },
  6: { potencial: 'Harmonia, responsabilidade, cuidado', risco: 'Perfeccionismo, controle excessivo' },
  7: { potencial: 'IntrospecÃ§Ã£o, sabedoria, espiritualidade', risco: 'Isolamento, ceticismo excessivo' },
  8: { potencial: 'Poder, realizaÃ§Ã£o material, abundÃ¢ncia', risco: 'Materialismo, ambiÃ§Ã£o desmedida' },
  9: { potencial: 'CompaixÃ£o, completude, humanitarismo', risco: 'MÃ¡rtir, apego ao passado' }
};

const cicloMenstrualFaseLunar = {
  'Lua Nova': {
    'menstruacao': 'Energia de recolhimento profundo. Momento ideal para descansar e ouvir seu corpo.',
    'pre_ovulacao': 'SensaÃ§Ã£o de renascimento e novas possibilidades. Energia criativa em ascensÃ£o.',
    'ovulacao': 'IntuiÃ§Ã£o aguÃ§ada e conexÃ£o com seus desejos mais profundos.',
    'pre_menstrual': 'ReflexÃ£o sobre o que precisa ser liberado para o prÃ³ximo ciclo.'
  },
  'Lua Crescente': {
    'menstruacao': 'ForÃ§a vital retornando gradualmente. Bom momento para planejamentos suaves.',
    'pre_ovulacao': 'Energia construtiva em alta. Ideal para colocar planos em aÃ§Ã£o.',
    'ovulacao': 'Poder de manifestaÃ§Ã£o no auge. Momento fÃ©rtil em todos os sentidos.',
    'pre_menstrual': 'ConsolidaÃ§Ã£o de aprendizados do ciclo.'
  },
  'Lua Cheia': {
    'menstruacao': 'EmoÃ§Ãµes intensas Ã  flor da pele. Permita-se sentir sem julgamentos.',
    'pre_ovulacao': 'Clareza sobre seus desejos e intenÃ§Ãµes.',
    'ovulacao': 'Poder feminino em evidÃªncia. Celebre sua sensualidade e forÃ§a.',
    'pre_menstrual': 'RevelaÃ§Ãµes emocionais podem surgir com mais intensidade.'
  },
  'Lua Minguante': {
    'menstruacao': 'LiberaÃ§Ã£o fÃ­sica e emocional. Deixe ir o que nÃ£o serve mais.',
    'pre_ovulacao': 'PreparaÃ§Ã£o interna para novas fases.',
    'ovulacao': 'IntuiÃ§Ã£o profundamente conectada com ciclos maiores.',
    'pre_menstrual': 'Processamento emocional necessÃ¡rio antes do novo inÃ­cio.'
  }
};

const lunacoes2026 = {
  '2026-01-03': { fase: 'Lua Cheia', signo: 'CÃ¢ncer', icone: 'ğŸŒ•' },
  '2026-01-10': { fase: 'Lua Minguante', signo: 'Libra', icone: 'ğŸŒ˜' },
  '2026-01-18': { fase: 'Lua Nova', signo: 'CapricÃ³rnio', icone: 'ğŸŒ‘' },
  '2026-01-26': { fase: 'Lua Crescente', signo: 'Touro', icone: 'ğŸŒ’' },
  '2026-02-01': { fase: 'Lua Cheia', signo: 'LeÃ£o', icone: 'ğŸŒ•' },
  '2026-02-09': { fase: 'Lua Minguante', signo: 'EscorpiÃ£o', icone: 'ğŸŒ˜' },
  '2026-02-17': { fase: 'Lua Nova', signo: 'AquÃ¡rio', icone: 'ğŸŒ‘' },
  '2026-02-24': { fase: 'Lua Crescente', signo: 'GÃªmeos', icone: 'ğŸŒ’' },
  '2026-03-03': { fase: 'Lua Cheia', signo: 'Virgem', icone: 'ğŸŒ•' },
  '2026-03-11': { fase: 'Lua Minguante', signo: 'SagitÃ¡rio', icone: 'ğŸŒ˜' },
  '2026-03-18': { fase: 'Lua Nova', signo: 'Peixes', icone: 'ğŸŒ‘' },
  '2026-03-25': { fase: 'Lua Crescente', signo: 'CÃ¢ncer', icone: 'ğŸŒ’' },
  '2026-04-01': { fase: 'Lua Cheia', signo: 'Libra', icone: 'ğŸŒ•' },
  '2026-04-10': { fase: 'Lua Minguante', signo: 'CapricÃ³rnio', icone: 'ğŸŒ˜' },
  '2026-04-17': { fase: 'Lua Nova', signo: 'Ãries', icone: 'ğŸŒ‘' },
  '2026-04-23': { fase: 'Lua Crescente', signo: 'LeÃ£o', icone: 'ğŸŒ’' },
  '2026-05-01': { fase: 'Lua Cheia', signo: 'EscorpiÃ£o', icone: 'ğŸŒ•' },
  '2026-05-09': { fase: 'Lua Minguante', signo: 'AquÃ¡rio', icone: 'ğŸŒ˜' },
  '2026-05-16': { fase: 'Lua Nova', signo: 'Touro', icone: 'ğŸŒ‘' },
  '2026-05-23': { fase: 'Lua Crescente', signo: 'Virgem', icone: 'ğŸŒ’' },
  '2026-05-31': { fase: 'Lua Cheia', signo: 'SagitÃ¡rio', icone: 'ğŸŒ•' },
  '2026-06-08': { fase: 'Lua Minguante', signo: 'Peixes', icone: 'ğŸŒ˜' },
  '2026-06-14': { fase: 'Lua Nova', signo: 'GÃªmeos', icone: 'ğŸŒ‘' },
  '2026-06-21': { fase: 'Lua Crescente', signo: 'Virgem', icone: 'ğŸŒ’' },
  '2026-06-29': { fase: 'Lua Cheia', signo: 'CapricÃ³rnio', icone: 'ğŸŒ•' },
  '2026-07-07': { fase: 'Lua Minguante', signo: 'Ãries', icone: 'ğŸŒ˜' },
  '2026-07-14': { fase: 'Lua Nova', signo: 'CÃ¢ncer', icone: 'ğŸŒ‘' },
  '2026-07-21': { fase: 'Lua Crescente', signo: 'EscorpiÃ£o', icone: 'ğŸŒ’' },
  '2026-07-29': { fase: 'Lua Cheia', signo: 'AquÃ¡rio', icone: 'ğŸŒ•' },
  '2026-08-05': { fase: 'Lua Minguante', signo: 'Touro', icone: 'ğŸŒ˜' },
  '2026-08-12': { fase: 'Lua Nova', signo: 'LeÃ£o', icone: 'ğŸŒ‘' },
  '2026-08-19': { fase: 'Lua Crescente', signo: 'EscorpiÃ£o', icone: 'ğŸŒ’' },
  '2026-08-28': { fase: 'Lua Cheia', signo: 'Peixes', icone: 'ğŸŒ•' },
  '2026-09-04': { fase: 'Lua Minguante', signo: 'GÃªmeos', icone: 'ğŸŒ˜' },
  '2026-09-11': { fase: 'Lua Nova', signo: 'Virgem', icone: 'ğŸŒ‘' },
  '2026-09-18': { fase: 'Lua Crescente', signo: 'SagitÃ¡rio', icone: 'ğŸŒ’' },
  '2026-09-26': { fase: 'Lua Cheia', signo: 'Ãries', icone: 'ğŸŒ•' },
  '2026-10-03': { fase: 'Lua Minguante', signo: 'CÃ¢ncer', icone: 'ğŸŒ˜' },
  '2026-10-10': { fase: 'Lua Nova', signo: 'Libra', icone: 'ğŸŒ‘' },
  '2026-10-18': { fase: 'Lua Crescente', signo: 'AquÃ¡rio', icone: 'ğŸŒ’' },
  '2026-10-26': { fase: 'Lua Cheia', signo: 'Touro', icone: 'ğŸŒ•' },
  '2026-11-01': { fase: 'Lua Minguante', signo: 'LeÃ£o', icone: 'ğŸŒ˜' },
  '2026-11-09': { fase: 'Lua Nova', signo: 'EscorpiÃ£o', icone: 'ğŸŒ‘' },
  '2026-11-17': { fase: 'Lua Crescente', signo: 'Peixes', icone: 'ğŸŒ’' },
  '2026-11-24': { fase: 'Lua Cheia', signo: 'GÃªmeos', icone: 'ğŸŒ•' },
  '2026-12-01': { fase: 'Lua Minguante', signo: 'Virgem', icone: 'ğŸŒ˜' },
  '2026-12-08': { fase: 'Lua Nova', signo: 'SagitÃ¡rio', icone: 'ğŸŒ‘' },
  '2026-12-17': { fase: 'Lua Crescente', signo: 'Peixes', icone: 'ğŸŒ’' },
  '2026-12-23': { fase: 'Lua Cheia', signo: 'GÃªmeos', icone: 'ğŸŒ•' },
  '2026-12-30': { fase: 'Lua Minguante', signo: 'Libra', icone: 'ğŸŒ˜' }
};

const luaForaDeCurso = {
  '2026-01-02': '09:23â€“10:09',
  '2026-02-05': '14:10â€“15:02',
  '2026-03-07': '22:40â€“23:30',
  '2026-04-11': '06:15â€“07:01',
  '2026-05-04': '18:50â€“19:44',
  '2026-06-09': '03:12â€“04:00',
  '2026-07-12': '11:30â€“12:18',
  '2026-08-06': '20:05â€“21:00',
  '2026-09-10': '08:44â€“09:33',
  '2026-10-08': '16:10â€“17:02',
  '2026-11-09': '01:22â€“02:10',
  '2026-12-07': '13:40â€“14:28'
};

// ===== FUNÃ‡Ã•ES AUXILIARES =====
function calcularNumeroEnergia(dataISO) {
  const perfil = load('perfil') || {};
  const dataNascimento = perfil.dataNascimento;
  
  if (!dataNascimento) return null;
  
  try {
    const partes = dataNascimento.split('-');
    const dia = parseInt(partes[2]);
    const mes = parseInt(partes[1]);
    const anoAtual = 2026;
    
    let soma = dia + mes + anoAtual;
    
    while (soma > 9) {
      soma = soma.toString().split('').reduce((acc, num) => acc + parseInt(num), 0);
    }
    
    return soma;
  } catch (e) {
    console.error('Erro ao calcular numerologia:', e);
    return null;
  }
}

function determinarFaseCiclo(dataISO) {
  const perfil = load('perfil') || {};
  const ciclo = perfil.ciclo;
  
  if (!ciclo) return null;
  
  try {
    const dataCiclo = new Date(ciclo);
    const dataAtual = new Date(dataISO);
    
    const diffTime = dataAtual - dataCiclo;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    const cicloDia = diffDays % 28;
    
    if (cicloDia >= 0 && cicloDia <= 7) return 'menstruacao';
    if (cicloDia >= 8 && cicloDia <= 14) return 'pre_ovulacao';
    if (cicloDia >= 15 && cicloDia <= 21) return 'ovulacao';
    return 'pre_menstrual';
    
  } catch (e) {
    console.error('Erro ao determinar fase do ciclo:', e);
    return null;
  }
}

function avaliarDia(dataISO) {
  const perfil = load('perfil') || {};
  const lua = lunacoes2026[dataISO];
  const saba = sabas2026[dataISO];
  
  let oraculoHTML = '';
  
  if (saba) {
    oraculoHTML += `<strong>ğŸ”¥ Hoje Ã© dia do SabÃ¡ ${saba.nome} (${saba.tipo}).</strong><br>`;
    oraculoHTML += `Dia de celebrar ${saba.estacaoElemento.toLowerCase()}.<br><br>`;
  }
  
  if (lua) {
    const energiaFase = energiasLunares[lua.fase] || {};
    const energiaSigno = energiaSignoLunar[lua.signo] || {};
    
    oraculoHTML += `<strong>ğŸŒ™ Lua em ${lua.signo}:</strong><br>`;
    oraculoHTML += `Dia de ${energiaFase.energiaPrincipal || 'energia lunar'}. `;
    oraculoHTML += `Momento para ${energiaSigno[lua.fase] || 'alinhar-se com a energia do signo'}.<br><br>`;
  } else {
    oraculoHTML += `<strong>ğŸŒ™ Lua em trÃ¢nsito:</strong><br>`;
    oraculoHTML += `Continuidade do ciclo lunar em andamento.<br><br>`;
  }
  
  oraculoHTML += `<strong>âš¡ Energia do dia:</strong><br>`;
  
  const numeroEnergia = calcularNumeroEnergia(dataISO);
  if (numeroEnergia && energiaNumerologia[numeroEnergia]) {
    const energiaNum = energiaNumerologia[numeroEnergia];
    oraculoHTML += `${energiaNum.potencial}. `;
    oraculoHTML += `AtenÃ§Ã£o para ${energiaNum.risco.toLowerCase()}.<br>`;
  }
  
  const faseCiclo = determinarFaseCiclo(dataISO);
  if (lua && faseCiclo && cicloMenstrualFaseLunar[lua.fase] && cicloMenstrualFaseLunar[lua.fase][faseCiclo]) {
    oraculoHTML += `VocÃª poderÃ¡ se sentir ${cicloMenstrualFaseLunar[lua.fase][faseCiclo].toLowerCase()}<br><br>`;
  } else if (lua && !perfil.ciclo) {
    const energiaFase = energiasLunares[lua.fase] || {};
    oraculoHTML += `Dia para focar em ${energiaFase.acoesPositivas ? energiaFase.acoesPositivas.split(',')[0] : 'harmonia interna'}.<br><br>`;
  } else {
    oraculoHTML += `AtenÃ§Ã£o Ã s suas necessidades internas hoje.<br><br>`;
  }
  
  oraculoHTML += `<strong>âœ¨ Ritual sugerido:</strong><br>`;
  if (saba) {
    oraculoHTML += `Dia de ${saba.rituais.split(',')[0]} e `;
  }
  
  if (lua) {
    if (lua.fase === 'Lua Cheia') {
      oraculoHTML += 'ritual de gratidÃ£o, escrita consciente e celebraÃ§Ã£o simbÃ³lica.';
    } else if (lua.fase === 'Lua Nova') {
      oraculoHTML += 'plantio de intenÃ§Ãµes, silÃªncio ritual e visualizaÃ§Ã£o.';
    } else if (lua.fase === 'Lua Crescente') {
      oraculoHTML += 'aÃ§Ãµes progressivas, fortalecimento de hÃ¡bitos e foco.';
    } else if (lua.fase === 'Lua Minguante') {
      oraculoHTML += 'limpeza energÃ©tica, desapego e descanso consciente.';
    } else {
      oraculoHTML += 'prÃ¡tica simples de autocuidado e observaÃ§Ã£o.';
    }
  } else {
    oraculoHTML += 'prÃ¡tica simples de autocuidado e observaÃ§Ã£o.';
  }
  
  return oraculoHTML;
}

// ===== FUNÃ‡Ã•ES DO PLANNER =====
function criarPlanner() {
  grid.innerHTML = '';
  const total = new Date(anoAtual, mesAtual + 1, 0).getDate();
  const inicio = new Date(anoAtual, mesAtual, 1).getDay();
  mesTitulo.textContent = new Date(anoAtual, mesAtual).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });

  for (let i = 0; i < inicio; i++) {
    const v = document.createElement('div');
    v.style.visibility = 'hidden';
    grid.appendChild(v);
  }

  const notas = load('notas') || {};
  const sentimentos = load('sentimentos') || {};

  for (let d = 1; d <= total; d++) {
    const dataISO = `${anoAtual}-${String(mesAtual + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
    const el = document.createElement('div');
    el.className = 'dia';

    let icones = '';
    if (lunacoes2026[dataISO]) icones += lunacoes2026[dataISO].icone;
    if (sabas2026[dataISO]) icones += 'ğŸ”¥';
    if (luaForaDeCurso[dataISO]) icones += 'â³';

    el.innerHTML = `<strong>${d}</strong>` + (icones ? `<div class="iconesTopo">${icones}</div>` : '');

    if ((Array.isArray(notas[dataISO]) && notas[dataISO].length) || sentimentos[dataISO]) {
      el.innerHTML += `<span class="estrela">âœ¶</span>`;
      
      const p = document.createElement('div');
      p.className = 'preview';
      
      if (Array.isArray(notas[dataISO]) && notas[dataISO].length) {
        p.textContent = notas[dataISO][notas[dataISO].length - 1].texto.substring(0, 40) + '...';
      } else if (sentimentos[dataISO]) {
        p.textContent = 'ğŸ’– ' + sentimentos[dataISO].substring(0, 40) + '...';
      }
      
      el.appendChild(p);
    }

    el.addEventListener('click', () => abrirModal(dataISO, d));
    grid.appendChild(el);
  }
}

// ===== FUNÃ‡ÃƒO ABRIR MODAL =====
function abrirModal(dataISO, dia) {
  diaAtual = dataISO;
  document.getElementById('modalTitulo').textContent = `Dia ${dia}`;
  
  oraculo.innerHTML = avaliarDia(dataISO);
  
  notasSalvas.innerHTML = '';
  sentimentosSalvos.innerHTML = '';
  
  const notas = load('notas') || {};
  if (Array.isArray(notas[dataISO])) {
    notas[dataISO].forEach((n, index) => {
      const div = document.createElement('div');
      div.className = 'nota-item';
      div.innerHTML = `
        <div class="nota-hora">${n.hora || 'Sem horÃ¡rio'}</div>
        <div class="nota-texto">${n.texto}</div>
        <button class="btn-apagar-nota" data-index="${index}" title="Apagar esta nota">ğŸ—‘ï¸</button>
      `;
      notasSalvas.appendChild(div);
    });
    
    document.querySelectorAll('.btn-apagar-nota').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const index = parseInt(this.getAttribute('data-index'));
        apagarNota(index);
      });
    });
  }
  
  const sentimentos = load('sentimentos') || {};
  if (sentimentos[dataISO]) {
    const div = document.createElement('div');
    div.className = 'sentimento-item';
    div.innerHTML = `
      <div style="color:var(--color-mystic-purple);font-weight:bold;font-size:0.875rem;">ğŸ’– ImpressÃµes e Sentimentos</div>
      <div style="color:var(--color-text-primary);font-size:0.9375rem;margin-top:8px;">${sentimentos[dataISO]}</div>
      <button class="btn-apagar-sentimento" title="Apagar sentimentos">ğŸ—‘ï¸</button>
    `;
    sentimentosSalvos.appendChild(div);
    
    document.querySelector('.btn-apagar-sentimento').addEventListener('click', function(e) {
      e.stopPropagation();
      apagarSentimento();
    });
  }
  
  const sentimentosField = document.getElementById('sentimentos');
  if (sentimentos[dataISO]) {
    sentimentosField.value = sentimentos[dataISO];
  } else {
    sentimentosField.value = '';
  }
  
  document.getElementById('notaHora').value = '';
  document.getElementById('notaTexto').value = '';
  
  const notificarNotaSelect = document.getElementById('notificarNota');
  const configNotificacaoDiv = document.getElementById('configNotificacao');
  
  notificarNotaSelect.value = 'nao';
  configNotificacaoDiv.style.display = 'none';
  
  notificarNotaSelect.addEventListener('change', function() {
    if (this.value === 'sim') {
      configNotificacaoDiv.style.display = 'block';
    } else {
      configNotificacaoDiv.style.display = 'none';
    }
  });
  
  modal.style.display = 'flex';
}

function apagarNota(index) {
  if (!confirm('Tem certeza que deseja apagar esta nota?')) {
    return;
  }
  
  const notas = load('notas') || {};
  
  if (Array.isArray(notas[diaAtual]) && notas[diaAtual][index]) {
    notas[diaAtual].splice(index, 1);
    
    if (notas[diaAtual].length === 0) {
      delete notas[diaAtual];
    }
    
    save('notas', notas);
    abrirModal(diaAtual, diaAtual.split('-')[2]);
    criarPlanner();
  }
}

function apagarSentimento() {
  if (!confirm('Tem certeza que deseja apagar suas impressÃµes e sentimentos deste dia?')) {
    return;
  }
  
  const sentimentos = load('sentimentos') || {};
  
  if (sentimentos[diaAtual]) {
    delete sentimentos[diaAtual];
    save('sentimentos', sentimentos);
    abrirModal(diaAtual, diaAtual.split('-')[2]);
    criarPlanner();
  }
}

// ===== FUNÃ‡ÃƒO SALVAR NOTA ATUALIZADA =====
function salvarNota() {
  try {
    const notaTexto = document.getElementById('notaTexto').value.trim();
    const sentimentosTexto = document.getElementById('sentimentos').value.trim();
    const notaHora = document.getElementById('notaHora').value;
    const notificarNota = document.getElementById('notificarNota').value;
    const tempoAntecedencia = parseInt(document.getElementById('tempoAntecedencia').value);
    
    console.log('Salvando nota:', { notaTexto, notaHora, notificarNota, tempoAntecedencia });
    
    let algoSalvo = false;
    
    // Salvar nota
    if (notaTexto) {
      const notas = load('notas') || {};
      if (!Array.isArray(notas[diaAtual])) notas[diaAtual] = [];
      
      const novaNota = { 
        hora: notaHora || 'Sem horÃ¡rio', 
        texto: notaTexto,
        data: new Date().toISOString(),
        tipo: 'lembrete'
      };
      
      notas[diaAtual].push(novaNota);
      save('notas', notas);
      algoSalvo = true;
      
      // Agendar notificaÃ§Ã£o se solicitado
      if (notificarNota === 'sim' && notaHora) {
        console.log('Agendando notificaÃ§Ã£o para nota:', { diaAtual, notaHora, tempoAntecedencia });
        agendarNotificacaoNota(diaAtual, notaHora, tempoAntecedencia, notaTexto);
        
        // Feedback visual
        const btn = document.getElementById('btnSalvarNota');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'ğŸ”” NotificaÃ§Ã£o Agendada!';
        btn.style.background = 'var(--color-digital-lavender)';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.style.background = '';
        }, 2000);
      }
    }
    
    // Salvar sentimentos
    if (sentimentosTexto) {
      const sentimentos = load('sentimentos') || {};
      sentimentos[diaAtual] = sentimentosTexto;
      save('sentimentos', sentimentos);
      algoSalvo = true;
    }
    
    if (!algoSalvo) {
      alert('Por favor, escreva uma nota ou seus sentimentos!');
      return;
    }
    
    // Fechar e atualizar
    fecharModal();
    criarPlanner();
    
    // Mostrar confirmaÃ§Ã£o
    setTimeout(() => {
      if (Notification.permission === 'granted' && notificarNota === 'sim' && notaHora) {
        // Enviar notificaÃ§Ã£o de teste imediata para confirmar
        setTimeout(() => {
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(reg => {
              reg.showNotification('ğŸ“ Nota Salva com Sucesso!', {
                body: `Lembrete agendado para ${notaHora}`,
                icon: 'icon-192.png',
                tag: 'teste-nota-salva'
              });
            });
          }
        }, 1000);
      }
    }, 500);
    
  } catch (error) {
    console.error('Erro ao salvar nota:', error);
    alert('âŒ Erro ao salvar: ' + error.message);
  }
}

function fecharModal() {
  modal.style.display = 'none';
  document.getElementById('notaTexto').value = '';
  document.getElementById('notaHora').value = '';
  document.getElementById('sentimentos').value = '';
}

// ===== FUNÃ‡Ã•ES DO LIVRO DA BRUXA PRÃ“SPERA =====
function recalcular() {
  const categorias = ['sustento', 'florescimento', 'centelha', 'abundancia'];
  let somaTotal = 0;

  categorias.forEach(cat => {
    let soma = 0;
    document.querySelectorAll(`#${cat} input[type="number"]`).forEach(i => {
      soma += Number(i.value) || 0;
    });
    if (document.getElementById(`total-${cat}`)) {
      document.getElementById(`total-${cat}`).textContent = soma.toFixed(2);
    }
    somaTotal += soma;
  });

  const totalAbundancia = Number(document.getElementById('total-abundancia').textContent) || 0;
  document.getElementById('saldo').textContent = (totalAbundancia - somaTotal).toFixed(2);
}

function addLinha(id, tipo) {
  const tbody = document.getElementById(id);
  if (!tbody) return;

  const tr = document.createElement('tr');

  const tdDesc = document.createElement('td');
  const inputDesc = document.createElement('input');
  inputDesc.placeholder = tipo === 'ganho' ? 'Descreva o ganho' : 'Descreva o gasto';
  tdDesc.appendChild(inputDesc);

  const tdValor = document.createElement('td');
  const inputValor = document.createElement('input');
  inputValor.type = 'number';
  inputValor.placeholder = '0.00';
  inputValor.oninput = recalcular;
  tdValor.appendChild(inputValor);

  const tdAcao = document.createElement('td');
  const btnRemover = document.createElement('button');
  btnRemover.textContent = 'âœ–';
  btnRemover.className = 'remover';
  btnRemover.onclick = () => tr.remove();
  tdAcao.appendChild(btnRemover);

  tr.appendChild(tdDesc);
  tr.appendChild(tdValor);
  tr.appendChild(tdAcao);

  tbody.appendChild(tr);
}

// ===== NAVEGAÃ‡ÃƒO =====
document.getElementById('irPlanner').onclick = () => {
  capa.style.display = 'none';
  planner.style.display = 'block';
  const p = load('perfil');
  if (p) perfilEl.textContent = `${p.nome} Â· ${p.signo}`;
  criarPlanner();
};

document.getElementById('irProspera').onclick = () => {
  capa.style.display = 'none';
  prospera.style.display = 'block';
};

document.getElementById('voltarCapa').onclick = () => {
  planner.style.display = 'none';
  capa.style.display = 'block';
};

document.getElementById('voltarCapa2').onclick = () => {
  prospera.style.display = 'none';
  capa.style.display = 'block';
};

document.getElementById('mesAnterior').onclick = () => {
  mesAtual--;
  if (mesAtual < 0) {
    mesAtual = 11;
    anoAtual--;
  }
  criarPlanner();
};

document.getElementById('mesProximo').onclick = () => {
  mesAtual++;
  if (mesAtual > 11) {
    mesAtual = 0;
    anoAtual++;
  }
  criarPlanner();
};

// ===== EVENTOS DO MODAL =====
document.getElementById('btnFechar').onclick = fecharModal;
document.getElementById('btnSalvarNota').onclick = salvarNota;

// ===== INICIALIZAÃ‡ÃƒO =====
addLinha('sustento');
addLinha('abundancia', 'ganho');
addLinha('florescimento');
addLinha('centelha');

// ===== BOTÃƒO DE TESTE TEMPORÃRIO =====
setTimeout(() => {
  if (document.getElementById('capa') && !document.getElementById('btnTesteNota')) {
    const btnTeste = document.createElement('button');
    btnTeste.id = 'btnTesteNota';
    btnTeste.innerHTML = 'ğŸ”” Testar NotificaÃ§Ã£o de Nota';
    btnTeste.style.margin = '10px';
    btnTeste.onclick = () => {
      enviarNotificacaoNota(
        'Esta Ã© uma nota de teste do planner ritualÃ­stico!',
        '14:30',
        'teste-' + Date.now()
      );
    };
    
    const capaDiv = document.getElementById('capa');
    if (capaDiv) {
      const primeiroBotao = capaDiv.querySelector('button');
      if (primeiroBotao) {
        primeiroBotao.parentNode.insertBefore(btnTeste, primeiroBotao.nextSibling);
      }
    }
  }
}, 2000);
</script>
</body>
</html>
