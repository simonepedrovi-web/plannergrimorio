<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planner Ritual√≠stico ‚Äî Grim√≥rio Completo</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- Fontes otimizadas para leitura -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Inter:wght@300;400;500;600&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
  
  <style>
    /* VARI√ÅVEIS DE CORES - PALETA ACESS√çVEL 2026 */
    :root {
      /* Cores neutras org√¢nicas - PAPEL COMO PADR√ÉO DEFINITIVO */
      --color-cloud-dancer: #e8dfca; /* Papel reciclado como cor definitiva */
      --color-bone-white: #f9f6ef;   /* Tom de pergaminho suave */
      --color-parchment: #f5f1e8;    /* Pergaminho claro */
      
      /* Cores de texto */
      --color-obsidian: #1a1a1a;     /* Quase preto, melhor que #000 */
      --color-deep-teal: #0d2b2e;    /* Verde muito escuro */
      --color-text-primary: #121212; /* Cinza escuro para melhor legibilidade */
      --color-text-secondary: #424242;
      
      /* Cores de destaque - Tend√™ncias 2026 */
      --color-digital-lavender: #b5a8ff; /* Cor do ano 2026 */
      --color-transformative-teal: #2a7a7a; /* Verde-azulado transformativo */
      --color-mystic-purple: #7e57c2;     /* Roxo m√≠stico */
      --color-sunset-amber: #ff8a50;      /* √Çmbar do p√¥r do sol */
      
      /* Tipografia */
      --font-heading: 'Cormorant Garamond', Georgia, serif;
      --font-body: 'Inter', 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mystic: 'Cormorant Garamond', serif;
      
      /* Espa√ßamento */
      --line-height-body: 1.6;
      --line-height-heading: 1.3;
      --letter-spacing-wide: 0.02em;
      --letter-spacing-tight: -0.01em;
      
      /* Bordas */
      --border-radius-sm: 8px;
      --border-radius-md: 12px;
      --border-radius-lg: 20px;
      
      /* Sombras suaves */
      --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.05);
      --shadow-medium: 0 8px 24px rgba(0, 0, 0, 0.08);
      --shadow-deep: 0 12px 36px rgba(0, 0, 0, 0.12);
    }
    
    /* ESTILOS GERAIS DO CORPO - FUNDO EM PAPEL DEFINITIVO */
    body {
      font-family: var(--font-body);
      background: var(--color-cloud-dancer); /* Cor de papel reciclado como padr√£o */
      margin: 0;
      padding: 0;
      color: var(--color-text-primary);
      min-height: 100vh;
      line-height: var(--line-height-body);
      letter-spacing: var(--letter-spacing-wide);
    }

    body::before {
      content: '‚òæ ‚ú∂ ‚öù ‚òø ‚ôÄ ‚ôÇ ‚öó üúÉ üúÅ üúÇ üúÑ';
      position: fixed;
      inset: 0;
      opacity: 0.03;
      font-size: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      font-family: var(--font-mystic);
      color: var(--color-text-secondary);
    }

    /* TELA DE INSTALA√á√ÉO */
    #installOverlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--color-transformative-teal), var(--color-deep-teal));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    #installContainer {
      background: var(--color-bone-white);
      padding: 32px;
      border-radius: var(--border-radius-lg);
      width: 90%;
      max-width: 420px;
      border: 1px solid rgba(0,0,0,0.1);
      text-align: center;
      box-sizing: border-box;
      box-shadow: var(--shadow-deep);
    }

    /* TELA DE FORMUL√ÅRIO */
    #formOverlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #e7dff0, #cbb7d8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    #formContainer {
      background: var(--color-bone-white);
      padding: 28px;
      border-radius: var(--border-radius-lg);
      width: 90%;
      max-width: 400px;
      border: 1px solid rgba(0,0,0,0.1);
      margin: 20px auto;
      box-sizing: border-box;
      box-shadow: var(--shadow-deep);
    }

    /* TIPOGRAFIA - T√çTULOS */
    h1, h2, h3, h4 {
      font-family: var(--font-heading);
      color: var(--color-deep-teal);
      font-weight: 600;
      line-height: var(--line-height-heading);
      letter-spacing: var(--letter-spacing-tight);
      margin-top: 0;
    }

    h1 {
      font-size: 2.5rem;
      text-align: center;
      margin: 20px 0;
      color: var(--color-transformative-teal);
    }

    h2 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    h3 {
      font-size: 1.5rem;
      margin-bottom: 0.75rem;
    }

    h4 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }

    /* TIPOGRAFIA - CORPO */
    .texto, p, label, input, select, textarea, button {
      font-family: var(--font-body);
      font-size: 1rem; /* 16px base */
      line-height: var(--line-height-body);
      color: var(--color-text-primary);
    }

    label {
      display: block;
      margin-top: 16px;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--color-text-secondary);
    }

    /* BOT√ïES - ACESS√çVEIS */
    button {
      margin-top: 12px;
      background: var(--color-transformative-teal);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: var(--border-radius-md);
      cursor: pointer;
      font-family: var(--font-body);
      font-weight: 500;
      font-size: 1rem;
      letter-spacing: var(--letter-spacing-wide);
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover, button:focus {
      background: var(--color-digital-lavender);
      transform: translateY(-2px);
      box-shadow: var(--shadow-soft);
      outline: 2px solid var(--color-digital-lavender);
      outline-offset: 2px;
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: transparent;
      border: 2px solid var(--color-transformative-teal);
      color: var(--color-transformative-teal);
    }

    button.secondary:hover {
      background: var(--color-transformative-teal);
      color: white;
    }

    /* INPUTS E FORMUL√ÅRIOS */
    input, select, textarea {
      width: 100%;
      margin-bottom: 12px;
      box-sizing: border-box;
      padding: 12px 16px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: var(--border-radius-sm);
      background: white;
      font-family: var(--font-body);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: 2px solid var(--color-digital-lavender);
      border-color: transparent;
      box-shadow: 0 0 0 3px rgba(181, 168, 255, 0.1);
    }

    /* RESTANTE DO CSS ORIGINAL (ADAPTADO) */
    #capa, #planner, #prospera {
      display: none;
      padding: 24px;
      box-sizing: border-box;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      background: var(--color-bone-white);
      border-radius: var(--border-radius-lg);
      margin-top: 20px;
      box-shadow: var(--shadow-soft);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .dia {
      background: white;
      min-height: 120px;
      border-radius: var(--border-radius-md);
      padding: 12px;
      cursor: pointer;
      position: relative;
      color: var(--color-mystic-purple);
      font-size: 1rem;
      border: 1px solid rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }

    .dia:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-soft);
      border-color: var(--color-digital-lavender);
    }

    .dias-semana div {
      text-align: center;
      font-weight: 600;
      padding: 12px 0;
      color: var(--color-transformative-teal);
      font-family: var(--font-heading);
      font-size: 1.1rem;
    }

    .preview {
      font-size: 0.875rem;
      margin-top: 8px;
      font-style: italic;
      word-break: break-word;
      color: var(--color-text-secondary);
      line-height: 1.4;
    }

    .estrela {
      position: absolute;
      bottom: 12px;
      right: 12px;
      font-size: 1rem;
      color: var(--color-sunset-amber);
    }

    .iconesTopo {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 4px;
      font-size: 0.875rem;
    }

    .top-nav {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .legenda {
      font-size: 0.875rem;
      margin: 16px 0;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: center;
      color: var(--color-text-secondary);
    }

    /* MAIN RESPONSIVO */
    main {
      display: grid;
      grid-template-columns: 1fr;
      gap: 32px;
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 20px;
      box-sizing: border-box;
    }

    section {
      background: var(--color-bone-white);
      padding: 24px;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(0,0,0,0.05);
      width: 100%;
      box-sizing: border-box;
    }

    .texto {
      color: var(--color-text-secondary);
      font-size: 1.0625rem; /* 17px para melhor leitura */
      line-height: var(--line-height-body);
      text-align: justify;
      margin-bottom: 1.5rem;
    }

    .livro label {
      display: block;
      margin-top: 20px;
      font-size: 0.9375rem;
    }

    .livro input {
      width: 100%;
      box-sizing: border-box;
      padding: 12px 16px;
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(0,0,0,0.1);
      background: white;
      font-family: var(--font-body);
    }

    .caixa {
      box-sizing: border-box;
      background: white;
      color: var(--color-text-primary);
      padding: 20px;
      border-radius: var(--border-radius-md);
      margin-top: 24px;
      overflow-x: auto;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .lateral {
      position: static;
      top: auto;
    }

    .lunar {
      background: var(--color-bone-white);
      border: 2px dashed var(--color-transformative-teal);
      padding: 24px;
      border-radius: var(--border-radius-md);
      font-size: 0.9375rem;
    }

    .lunar strong {
      color: var(--color-transformative-teal);
    }

    .tabela {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      min-width: 300px;
    }

    .tabela th, .tabela td {
      border-bottom: 1px solid rgba(0,0,0,0.1);
      padding: 12px;
      font-size: 0.9375rem;
    }

    .tabela th {
      color: var(--color-transformative-teal);
      font-weight: 600;
      text-align: left;
    }

    .tabela input {
      width: 100%;
      box-sizing: border-box;
      border: none;
      background: transparent;
      font-family: var(--font-body);
      font-size: 0.9375rem;
    }

    .total-secao {
      margin-top: 16px;
      font-size: 0.9375rem;
      color: var(--color-transformative-teal);
      font-weight: 600;
    }

    .saldo {
      margin-top: 24px;
      padding: 20px;
      background: linear-gradient(135deg, var(--color-digital-lavender), var(--color-mystic-purple));
      border-radius: var(--border-radius-md);
      color: white;
      font-weight: 600;
    }

    .grafico {
      margin-top: 24px;
      background: var(--color-bone-white);
      border: 1px solid var(--color-transformative-teal);
      border-radius: var(--border-radius-md);
      padding: 20px;
      color: var(--color-transformative-teal);
      font-size: 0.9375rem;
    }

    /* MODAL RESPONSIVO */
    #modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 2000;
    }

    #modal > div {
      background: var(--color-bone-white);
      padding: 24px;
      border-radius: var(--border-radius-lg);
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
      margin: 0 auto;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-deep);
    }

    .sentimentos-section {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: var(--border-radius-md);
      border: 1px solid rgba(0,0,0,0.05);
    }

    .sentimentos-section label {
      display: block;
      margin-bottom: 12px;
      color: var(--color-transformative-teal);
      font-weight: 600;
      font-size: 1rem;
    }

    #sentimentos {
      width: 100%;
      min-height: 100px;
      padding: 16px;
      border-radius: var(--border-radius-sm);
      border: 1px solid rgba(0,0,0,0.1);
      background: white;
      font-family: var(--font-body);
      font-size: 1rem;
      resize: vertical;
      box-sizing: border-box;
      line-height: var(--line-height-body);
    }

    .nota-item {
      margin: 12px 0;
      padding: 16px;
      background: white;
      border-radius: var(--border-radius-md);
      border-left: 4px solid var(--color-transformative-teal);
      position: relative;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .nota-hora {
      font-size: 0.8125rem;
      color: var(--color-transformative-teal);
      font-weight: 600;
      margin-right: 40px;
    }

    .nota-texto {
      font-size: 0.9375rem;
      color: var(--color-text-primary);
      margin-top: 8px;
      margin-right: 40px;
      line-height: var(--line-height-body);
    }

    .btn-apagar-nota {
      position: absolute;
      top: 12px;
      right: 12px;
      background: transparent;
      border: none;
      color: var(--color-text-secondary);
      cursor: pointer;
      font-size: 0.875rem;
      padding: 6px 8px;
      border-radius: var(--border-radius-sm);
      transition: all 0.3s ease;
    }

    .btn-apagar-nota:hover {
      background: rgba(255, 138, 80, 0.1);
      transform: scale(1.1);
      color: var(--color-sunset-amber);
    }

    .sentimento-item {
      margin: 12px 0;
      padding: 16px;
      background: white;
      border-radius: var(--border-radius-md);
      border-left: 4px solid var(--color-mystic-purple);
      position: relative;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .btn-apagar-sentimento {
      position: absolute;
      top: 12px;
      right: 12px;
      background: transparent;
      border: none;
      color: var(--color-text-secondary);
      cursor: pointer;
      font-size: 0.875rem;
      padding: 6px 8px;
      border-radius: var(--border-radius-sm);
      transition: all 0.3s ease;
    }

    .btn-apagar-sentimento:hover {
      background: rgba(126, 87, 194, 0.1);
      transform: scale(1.1);
      color: var(--color-mystic-purple);
    }

    .oraculo-section {
      margin-bottom: 24px;
      padding: 20px;
      background: white;
      border-radius: var(--border-radius-md);
      border: 1px solid rgba(0,0,0,0.05);
    }

    .oraculo-title {
      color: var(--color-transformative-teal);
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 1.25rem;
      font-family: var(--font-heading);
    }

    .oraculo-text {
      color: var(--color-text-primary);
      font-size: 1rem;
      line-height: var(--line-height-body);
    }

    /* Bot√£o instalar */
    #btnInstalarAgora {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: none;
      background: var(--color-digital-lavender);
    }

    /* SE√á√ÉO DE NOTIFICA√á√ïES NO MODAL */
    .notificacoes-section {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: var(--border-radius-md);
      border: 1px solid rgba(0,0,0,0.05);
    }

    .notificacoes-section label {
      display: block;
      margin-bottom: 8px;
      color: var(--color-transformative-teal);
      font-weight: 500;
    }

    .notificacoes-section input[type="time"],
    .notificacoes-section input[type="number"] {
      width: 100%;
      margin-bottom: 12px;
    }

    .notificacoes-section select {
      width: 100%;
      margin-bottom: 12px;
    }

    /* MODAL DE CONFIGURA√á√ÉO DE NOTIFICA√á√ïES */
    #modalNotificacoes {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    #modalNotificacoes > div {
      background: var(--color-bone-white);
      padding: 24px;
      border-radius: var(--border-radius-lg);
      width: 100%;
      max-width: 500px;
      box-sizing: border-box;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-deep);
    }

    /* MEDIA QUERIES - RESPONSIVIDADE */
    @media (min-width: 768px) {
      main {
        grid-template-columns: 1.5fr 1fr;
        margin: 32px auto;
      }
      
      .lateral {
        position: sticky;
        top: 32px;
      }
      
      .grid {
        gap: 10px;
      }
      
      .dia {
        min-height: 140px;
        padding: 16px;
        font-size: 1.1rem;
      }
      
      h1 {
        font-size: 3rem;
      }
      
      h2 {
        font-size: 2.25rem;
      }
      
      h3 {
        font-size: 1.75rem;
      }
      
      /* Aumenta o tamanho da fonte para tablets */
      body {
        font-size: 1.0625rem;
      }
    }

    @media (max-width: 480px) {
      body::before {
        font-size: 80px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      h2, h3 {
        font-size: 1.5rem;
      }
      
      .grid {
        gap: 4px;
      }
      
      .dia {
        min-height: 100px;
        padding: 8px;
        font-size: 0.9375rem;
      }
      
      #modal > div {
        padding: 20px;
      }
      
      .oraculo-section {
        padding: 16px;
      }
      
      .nota-item, .sentimento-item {
        padding: 12px;
      }
      
      .btn-apagar-nota, .btn-apagar-sentimento {
        top: 8px;
        right: 8px;
        font-size: 0.8125rem;
      }
      
      /* Aumenta o tamanho da fonte para mobile */
      body {
        font-size: 1rem; /* 16px m√≠nimo para acessibilidade */
      }
      
      input, select, textarea, button {
        font-size: 1rem; /* Garante tamanho m√≠nimo */
      }
    }

    /* AJUSTES DE CONTRASTE WCAG */
    .oraculo-text {
      color: var(--color-text-primary);
      background: white;
    }
    
    .nota-texto {
      color: var(--color-text-primary);
    }
    
    /* Foco vis√≠vel para acessibilidade */
    *:focus {
      outline: 2px solid var(--color-digital-lavender);
      outline-offset: 2px;
    }
    
    /* Melhorando o contraste dos bot√µes */
    button {
      color: white;
      background-color: var(--color-transformative-teal);
    }
    
    button:hover {
      background-color: var(--color-digital-lavender);
    }
    
    /* Contraste nos links */
    a {
      color: var(--color-transformative-teal);
      text-decoration: underline;
    }
    
    a:hover {
      color: var(--color-digital-lavender);
    }
    
    /* Espa√ßamento entre par√°grafos */
    p {
      margin-bottom: 1.5rem;
    }
    
    /* Hierarquia clara de cabe√ßalhos */
    h1 { margin-bottom: 2rem; }
    h2 { margin-bottom: 1.5rem; }
    h3 { margin-bottom: 1rem; }
    h4 { margin-bottom: 0.75rem; }
  </style>
</head>
<body>

<!-- TELA DE INSTALA√á√ÉO -->
<div id="installOverlay">
  <div id="installContainer">
    <h2>‚ú® Instalar Grim√≥rio Ritual√≠stico ‚ú®</h2>
    <p>Instale o aplicativo para uma experi√™ncia completa, com notifica√ß√µes lunares e acesso offline.</p>
    <button id="btnInstalarPWA">üì≤ Instalar Agora</button>
    <button id="btnPularInstalacao" class="secondary">üåê Usar na Web</button>
    <p style="font-size:0.875rem;margin-top:20px;opacity:0.8;">
      Voc√™ pode instalar depois a qualquer momento atrav√©s do menu do navegador.
    </p>
  </div>
</div>

<!-- TELA DE FORMUL√ÅRIO -->
<div id="formOverlay">
  <div id="formContainer">
    <h3>Identifica√ß√£o da Bruxa</h3>
    <label>Seu nome m√°gico</label>
    <input id="nome" placeholder="Digite seu nome ou apelido" autocomplete="off">
    <label>Signo</label>
    <select id="signo">
      <option value="">Selecione seu signo</option>
      <option>√Åries</option><option>Touro</option><option>G√™meos</option>
      <option>C√¢ncer</option><option>Le√£o</option><option>Virgem</option>
      <option>Libra</option><option>Escorpi√£o</option><option>Sagit√°rio</option>
      <option>Capric√≥rnio</option><option>Aqu√°rio</option><option>Peixes</option>
    </select>
    <label>Ano pessoal (opcional)</label>
    <select id="anoPessoal">
      <option value="">Selecione seu ano pessoal</option>
      <option>1</option><option>2</option><option>3</option><option>4</option>
      <option>5</option><option>6</option><option>7</option><option>8</option><option>9</option>
    </select>
    <label>Data de nascimento (para numerologia)</label>
    <input id="dataNascimento" type="date">
    <label>Pr√≥ximo ciclo menstrual (opcional)</label>
    <input id="ciclo" type="date">
    <button id="salvar">‚ú® Entrar no Grim√≥rio</button>
    <p style="font-size:0.875rem;margin-top:15px;opacity:0.8;">
      Seus dados s√£o armazenados apenas no seu dispositivo.
    </p>
  </div>
</div>

<!-- Bot√£o para instalar depois -->
<button id="btnInstalarAgora" style="display:none">
  üì≤ Instalar
</button>

<!-- CAPA -->
<div id="capa">
  <h2>Bem-vinda ao Grim√≥rio</h2>
  <p id="nomeCapa"></p>
  <button id="irPlanner">üìÖ Planner Mensal</button>
  <button id="irProspera">üí∞ Livro da Bruxa Pr√≥spera</button>
  <div style="margin-top:30px;">
    <button id="btnAlterarNome" class="secondary">‚úèÔ∏è Alterar meus dados</button>
    <button id="btnConfigNotificacoes" class="secondary">üîî Configurar Notifica√ß√µes</button>
  </div>
</div>

<!-- PLANNER -->
<div id="planner">
  <div class="top-nav"><button id="voltarCapa" class="secondary">‚üµ Capa</button></div>
  <h2 id="perfil"></h2>
  <div class="legenda">
    <span>üåëüåíüåïüåò Luna√ß√£o</span>
    <span>üî• Sab√°</span>
    <span>‚è≥ Lua fora de curso</span>
  </div>
  <div id="mesTitulo"></div>
  <div style="display:flex;justify-content:space-between;margin:16px 0">
    <button id="mesAnterior">‚óÄ</button>
    <button id="mesProximo">‚ñ∂</button>
  </div>
  <div class="grid dias-semana"><div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>S√°b</div></div>
  <div class="grid" id="grid"></div>
</div>

<!-- MODAL ATUALIZADO -->
<div id="modal" style="display:none">
  <div>
    <h3 id="modalTitulo" style="color:var(--color-transformative-teal);margin-bottom:20px;"></h3>
    
    <!-- OR√ÅCULO -->
    <div class="oraculo-section">
      <div class="oraculo-title">üåô Or√°culo do Dia</div>
      <div id="oraculo" class="oraculo-text"></div>
    </div>
    
    <!-- SE√á√ÉO DE NOTAS SALVAS -->
    <div id="notasSalvas"></div>
    
    <!-- SE√á√ÉO DE SENTIMENTOS SALVOS -->
    <div id="sentimentosSalvos" style="margin-top:20px;"></div>
    
    <!-- FORMUL√ÅRIO PARA NOVA NOTA -->
    <div style="margin-top:24px;padding-top:20px;border-top:2px dashed var(--color-transformative-teal);">
      <h4 style="color:var(--color-transformative-teal);margin-bottom:16px;">‚ûï Nova Nota</h4>
      <input type="time" id="notaHora" style="margin-bottom:16px;" />
      <textarea id="notaTexto" placeholder="Escreva sua nota aqui..." style="height:100px;width:100%;box-sizing:border-box;margin-bottom:20px;"></textarea>
      
      <!-- SE√á√ÉO DE NOTIFICA√á√ïES PARA A NOTA -->
      <div class="notificacoes-section">
        <label for="notificarNota">üîî Receber lembrete desta nota?</label>
        <select id="notificarNota">
          <option value="nao">N√£o receber notifica√ß√£o</option>
          <option value="sim">Sim, receber notifica√ß√£o</option>
        </select>
        
        <div id="configNotificacao" style="display:none;">
          <label for="tempoAntecedencia">Tempo de anteced√™ncia:</label>
          <select id="tempoAntecedencia">
            <option value="5">5 minutos antes</option>
            <option value="15">15 minutos antes</option>
            <option value="30">30 minutos antes</option>
            <option value="60">1 hora antes</option>
            <option value="120">2 horas antes</option>
            <option value="1440">1 dia antes</option>
          </select>
        </div>
      </div>
      
      <!-- CAMPO: IMPRESS√ïES E SENTIMENTOS -->
      <div class="sentimentos-section">
        <label for="sentimentos">üíñ Impress√µes e Sentimentos</label>
        <textarea id="sentimentos" placeholder="Como voc√™ est√° se sentindo? Quais foram suas impress√µes deste dia? Escreva livremente..."></textarea>
      </div>
      
      <div style="display:flex;gap:12px;margin-top:20px;">
        <button id="btnSalvarNota">üíæ Salvar Nota</button>
        <button id="btnFechar" class="secondary">‚úñ Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE CONFIGURA√á√ÉO DE NOTIFICA√á√ïES -->
<div id="modalNotificacoes" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:2000; padding:20px;">
  <div style="background:var(--color-bone-white); padding:24px; border-radius:var(--border-radius-lg); width:100%; max-width:500px; box-sizing:border-box; max-height:90vh; overflow-y:auto;">
    <h3 style="color:var(--color-transformative-teal);margin-bottom:20px;">üîî Configurar Notifica√ß√µes</h3>
    
    <div class="notificacoes-section">
      <label for="notificacoesAtivas">üì¢ Ativar notifica√ß√µes?</label>
      <select id="notificacoesAtivas">
        <option value="sim">Sim, receber notifica√ß√µes</option>
        <option value="nao">N√£o receber notifica√ß√µes</option>
      </select>
      
      <label for="horaNotificacaoDiaria">‚è∞ Hora para notifica√ß√£o di√°ria:</label>
      <input type="time" id="horaNotificacaoDiaria" value="08:00">
      
      <label for="notificarSabas">üî• Notificar sobre Sab√°s?</label>
      <select id="notificarSabas">
        <option value="sim">Sim, notificar sobre Sab√°s</option>
        <option value="nao">N√£o notificar sobre Sab√°s</option>
      </select>
      
      <label for="antecedenciaSabas">üìÖ Anteced√™ncia para Sab√°s:</label>
      <select id="antecedenciaSabas">
        <option value="1">1 dia antes</option>
        <option value="2">2 dias antes</option>
        <option value="3">3 dias antes</option>
        <option value="7">1 semana antes</option>
      </select>
      
      <label for="horaNotificacaoSabas">‚è∞ Hora para notifica√ß√£o de Sab√°s:</label>
      <input type="time" id="horaNotificacaoSabas" value="09:00">
    </div>
    
    <div style="display:flex;gap:12px;margin-top:20px;">
      <button id="btnSalvarConfigNotificacoes">üíæ Salvar Configura√ß√µes</button>
      <button id="btnFecharNotificacoes" class="secondary">‚úñ Fechar</button>
    </div>
    
    <p style="font-size:0.875rem;margin-top:15px;opacity:0.8;">
      As notifica√ß√µes funcionam melhor com o aplicativo instalado.
    </p>
  </div>
</div>

<!-- BRUXA PR√ìSPERA -->
<div id="prospera">
  <div class="top-nav"><button id="voltarCapa2" class="secondary">‚üµ Capa</button></div>
 <h1>üìñ Livro da Bruxa Pr√≥spera</h1>

<main>

  <section class="livro">

    <h2>‚ú¶ Fonte de Abund√¢ncia</h2>
    <div class="texto">Registre todos os ganhos que chegam at√© voc√™ atrav√©s do seu trabalho, trocas, servi√ßos ou vendas.</div>
    <div class="caixa">
      <table class="tabela">
        <thead><tr><th>Origem do ganho</th><th>Valor</th><th></th></tr></thead>
        <tbody id="abundancia"></tbody>
      </table>
      <button onclick="addLinha('abundancia','ganho')">+ adicionar ganho</button>
      <div class="total-secao">Total Abund√¢ncia: R$ <span id="total-abundancia">0</span></div>
    </div>

    <h2 style="margin-top:34px">‚ú¶ Fluidez</h2>
    <div class="texto">Aqui voc√™ observa para onde sua energia financeira escoa ‚Äî como voc√™ gasta, sustenta e nutre sua vida.</div>

    <h3>A) Sustento</h3><div class="texto">Despesas essenciais para sua sobreviv√™ncia material: moradia, contas, transporte, alimenta√ß√£o.</div>
    <div class="caixa">
      <table class="tabela">
        <thead><tr><th>Descri√ß√£o</th><th>Valor</th><th></th></tr></thead>
        <tbody id="sustento"></tbody>
      </table>
      <button onclick="addLinha('sustento')">+ adicionar gasto</button>
    </div>
<br> </br>
    <h3>B) Florescimento</h3><div class="texto">Gastos que ampliam prazer, aprendizado, descanso, cultura e bem-estar.</div>
    <div class="caixa">
      <table class="tabela">
        <thead><tr><th>Descri√ß√£o</th><th>Valor</th><th></th></tr></thead>
        <tbody id="florescimento"></tbody>
      </table>
      <button onclick="addLinha('florescimento')">+ adicionar gasto</button>
    </div>
<br> </br>
    <h3>C) Centelha Energ√©tica</h3><div class="texto">Gastos inesperados ou emergenciais que exigem energia imediata.</div>
    <div class="caixa">
      <table class="tabela">
        <thead><tr><th>Descri√ß√£o</th><th>Valor</th><th></th></tr></thead>
        <tbody id="centelha"></tbody>
      </table>
      <button onclick="addLinha('centelha')">+ adicionar gasto</button>
    </div>

    <h2 style="margin-top:34px">‚ú¶ Expans√£o</h2>
    <div class="texto">Reservas voltadas a investimentos futuros, sonhos, avan√ßos e projetos de longo prazo.</div>
    <div class="caixa">
      <label>Sementes de Prosperidade</label>
      <input placeholder="Valor reservado">
      <label>Sonho ou inten√ß√£o</label>
      <input placeholder="Liberdade, descanso, projeto...">
    </div>

        <div id="totais">
        <div class="total-secao">Total Sustento: R$ <span id="total-sustento">0</span></div>
        <div class="total-secao">Total Florescimento: R$ <span id="total-florescimento">0</span></div>
        <div class="total-secao">Total Centelha: R$ <span id="total-centelha">0</span></div>
        <div class="saldo">Saldo Energ√©tico do M√™s: R$ <span id="saldo">0</span></div>
      </div>

  </section>

  <aside class="lateral">
    <section class="lunar">
      <h3>üåô A Lua Observa Teu Ouro</h3>
      <p><strong>Lua Nova:</strong> planeje, defina metas, evite impulsos.</p>
      <p><strong>Lua Crescente:</strong> organize, negocie, expanda.</p>
      <p><strong>Lua Cheia:</strong> agrade√ßa, observe excessos.</p>
      <p><strong>Lua Minguante:</strong> corte gastos e libere padr√µes.</p>
      <div class="grafico" id="grafico">üìä Gr√°fico Ritual: Fluidez x Lua<br>(ativa√ß√£o simb√≥lica)</div>
    </section>
  </aside>

</main>

<script>
// ===== VARI√ÅVEIS GLOBAIS =====
let deferredPrompt = null;

// ===== ELEMENTOS =====
const installOverlay = document.getElementById('installOverlay');
const formOverlay = document.getElementById('formOverlay');
const btnInstalarPWA = document.getElementById('btnInstalarPWA');
const btnPularInstalacao = document.getElementById('btnPularInstalacao');
const btnInstalarAgora = document.getElementById('btnInstalarAgora');
const btnAlterarNome = document.getElementById('btnAlterarNome');
const btnConfigNotificacoes = document.getElementById('btnConfigNotificacoes');
const modalNotificacoes = document.getElementById('modalNotificacoes');
const btnFecharNotificacoes = document.getElementById('btnFecharNotificacoes');
const btnSalvarConfigNotificacoes = document.getElementById('btnSalvarConfigNotificacoes');
const capa = document.getElementById('capa');
const planner = document.getElementById('planner');
const prospera = document.getElementById('prospera');
const grid = document.getElementById('grid');
const mesTitulo = document.getElementById('mesTitulo');
const perfilEl = document.getElementById('perfil');
const nomeCapa = document.getElementById('nomeCapa');
const modal = document.getElementById('modal');
const oraculo = document.getElementById('oraculo');
const notasSalvas = document.getElementById('notasSalvas');
const sentimentosSalvos = document.getElementById('sentimentosSalvos');

let mesAtual = new Date().getMonth();
let anoAtual = 2026;
let diaAtual = null;

// ===== FUN√á√ïES DE ARMAZENAMENTO =====
function save(k, v) {
  localStorage.setItem(k, JSON.stringify(v));
}

function load(k) {
  const v = localStorage.getItem(k);
  return v ? JSON.parse(v) : null;
}

// ===== FLUXO DE INSTALA√á√ÉO =====
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  if (btnInstalarAgora) {
    btnInstalarAgora.style.display = 'block';
  }
  
  const hasVisited = localStorage.getItem('hasVisited');
  if (!hasVisited) {
    installOverlay.style.display = 'flex';
    formOverlay.style.display = 'none';
  }
});

btnInstalarPWA.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  
  deferredPrompt.prompt();
  const choiceResult = await deferredPrompt.userChoice;
  
  if (choiceResult.outcome === 'accepted') {
    console.log('Usu√°rio aceitou instalar o PWA');
  }
  
  deferredPrompt = null;
  installOverlay.style.display = 'none';
  formOverlay.style.display = 'flex';
  localStorage.setItem('hasVisited', 'true');
});

btnPularInstalacao.addEventListener('click', () => {
  installOverlay.style.display = 'none';
  formOverlay.style.display = 'flex';
  localStorage.setItem('hasVisited', 'true');
});

btnInstalarAgora.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  
  deferredPrompt.prompt();
  const choiceResult = await deferredPrompt.userChoice;
  
  if (choiceResult.outcome === 'accepted') {
    btnInstalarAgora.style.display = 'none';
  }
});

// ===== CONFIGURA√á√ÉO DE NOTIFICA√á√ïES =====
btnConfigNotificacoes.addEventListener('click', () => {
  const config = load('configNotificacoes') || {
    ativas: 'sim',
    horaDiaria: '08:00',
    notificarSabas: 'sim',
    antecedenciaSabas: '1',
    horaSabas: '09:00'
  };
  
  document.getElementById('notificacoesAtivas').value = config.ativas;
  document.getElementById('horaNotificacaoDiaria').value = config.horaDiaria;
  document.getElementById('notificarSabas').value = config.notificarSabas;
  document.getElementById('antecedenciaSabas').value = config.antecedenciaSabas;
  document.getElementById('horaNotificacaoSabas').value = config.horaSabas;
  
  modalNotificacoes.style.display = 'flex';
});

btnFecharNotificacoes.addEventListener('click', () => {
  modalNotificacoes.style.display = 'none';
});

btnSalvarConfigNotificacoes.addEventListener('click', () => {
  const config = {
    ativas: document.getElementById('notificacoesAtivas').value,
    horaDiaria: document.getElementById('horaNotificacaoDiaria').value,
    notificarSabas: document.getElementById('notificarSabas').value,
    antecedenciaSabas: document.getElementById('antecedenciaSabas').value,
    horaSabas: document.getElementById('horaNotificacaoSabas').value
  };
  
  save('configNotificacoes', config);
  agendarNotificacoes();
  modalNotificacoes.style.display = 'none';
  alert('Configura√ß√µes de notifica√ß√µes salvas!');
});

// ===== FORMUL√ÅRIO =====
document.getElementById('salvar').onclick = () => {
  const nome = document.getElementById('nome').value.trim();
  const signo = document.getElementById('signo').value;
  const ano = document.getElementById('anoPessoal').value;
  const dataNascimento = document.getElementById('dataNascimento').value;
  const ciclo = document.getElementById('ciclo').value;

  if (!nome) {
    alert('Por favor, digite seu nome m√°gico!');
    return;
  }

  if (!signo) {
    alert('Por favor, selecione seu signo!');
    return;
  }

  const perfil = {
    nome: nome,
    signo: signo,
    ano: ano || '',
    dataNascimento: dataNascimento || '',
    ciclo: ciclo || ''
  };

  save('perfil', perfil);
  solicitarPermissaoNotificacao();
  nomeCapa.textContent = `Salve, ${perfil.nome}`;
  formOverlay.style.display = 'none';
  capa.style.display = 'block';
  localStorage.setItem('formPreenchido', 'true');
  
  const configNotificacoes = load('configNotificacoes');
  if (!configNotificacoes) {
    save('configNotificacoes', {
      ativas: 'sim',
      horaDiaria: '08:00',
      notificarSabas: 'sim',
      antecedenciaSabas: '1',
      horaSabas: '09:00'
    });
  }
};

btnAlterarNome.addEventListener('click', () => {
  const perfilAtual = load('perfil') || {};
  document.getElementById('nome').value = perfilAtual.nome || '';
  document.getElementById('signo').value = perfilAtual.signo || '';
  document.getElementById('anoPessoal').value = perfilAtual.ano || '';
  document.getElementById('dataNascimento').value = perfilAtual.dataNascimento || '';
  document.getElementById('ciclo').value = perfilAtual.ciclo || '';
  capa.style.display = 'none';
  formOverlay.style.display = 'flex';
});

// ===== VERIFICA√á√ÉO INICIAL =====
window.addEventListener('load', () => {
  const perfilSalvo = load('perfil');
  
  if (perfilSalvo && perfilSalvo.nome) {
    formOverlay.style.display = 'none';
    capa.style.display = 'block';
    nomeCapa.textContent = `Salve, ${perfilSalvo.nome} ‚ú®`;
  } else {
    const hasVisited = localStorage.getItem('hasVisited');
    if (!hasVisited && deferredPrompt) {
      installOverlay.style.display = 'flex';
      formOverlay.style.display = 'none';
    }
  }
  
  // Registrar Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(registration => {
        console.log('Service Worker registrado:', registration.scope);
      })
      .catch(err => {
        console.error('Erro no Service Worker:', err);
      });
  }
  
  // Agendar notifica√ß√µes ap√≥s carregar
  setTimeout(() => {
    agendarNotificacoes();
  }, 2000);
});

// ===== FUN√á√ïES DE NOTIFICA√á√ÉO =====
function solicitarPermissaoNotificacao() {
  if (!('Notification' in window)) {
    console.log('Este navegador n√£o suporta notifica√ß√µes.');
    return;
  }
  
  if (Notification.permission === 'default') {
    Notification.requestPermission().then(permission => {
      if (permission === 'granted') {
        console.log('Permiss√£o para notifica√ß√µes concedida.');
        setTimeout(() => agendarNotificacoes(), 1000);
      }
    });
  }
}

function agendarNotificacoes() {
  console.log('Agendando notifica√ß√µes...');
  
  const config = load('configNotificacoes');
  if (!config || config.ativas === 'nao') {
    console.log('Notifica√ß√µes desativadas.');
    return;
  }
  
  if (Notification.permission !== 'granted') {
    console.log('Permiss√£o n√£o concedida.');
    return;
  }
  
  // Cancelar todas as notifica√ß√µes anteriores
  cancelarTodasNotificacoes();
  
  // Agendar notifica√ß√µes de ALERTAS (eventos fixos)
  agendarAlertasFixos(config);
  
  // Agendar notifica√ß√µes de LEMBRETES (notas da usu√°ria)
  agendarLembretesNotas();
}

function cancelarTodasNotificacoes() {
  // Esta fun√ß√£o limpa notifica√ß√µes antigas ao recarregar as configura√ß√µes
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.ready.then(registration => {
      registration.getNotifications().then(notifications => {
        notifications.forEach(notification => {
          notification.close();
        });
      });
    });
  }
}

function agendarAlertasFixos(config) {
  console.log('Agendando ALERTAS fixos...');
  
  // Agendar notifica√ß√µes para fases lunares
  Object.keys(lunacoes2026).forEach(dataISO => {
    const lua = lunacoes2026[dataISO];
    const horario = luaForaDeCurso[dataISO] ? ` (Hor√°rio: ${luaForaDeCurso[dataISO].split('‚Äì')[0]})` : '';
    const mensagem = `Mudan√ßa de fase lunar hoje: ${lua.fase} em ${lua.signo}${horario}!`;
    
    agendarAlertaParaData(dataISO, '08:00', 'üåô Alerta Lunar', mensagem);
  });
  
  // Agendar notifica√ß√µes para Sab√°s com anteced√™ncia configur√°vel
  if (config.notificarSabas === 'sim') {
    const antecedenciaDias = parseInt(config.antecedenciaSabas);
    const horaSabas = config.horaSabas || '09:00';
    
    Object.keys(sabas2026).forEach(dataSab√° => {
      const sab√° = sabas2026[dataSab√°];
      
      // Agendar notifica√ß√£o no pr√≥prio dia do Sab√°
      const mensagemDia = `Hoje √© ${sab√°.nome}: ${sab√°.significado}`;
      agendarAlertaParaData(dataSab√°, horaSabas, `üî• ${sab√°.nome}`, mensagemDia);
      
      // Agendar notifica√ß√£o com anteced√™ncia
      if (antecedenciaDias > 0) {
        const dataAntecedencia = new Date(dataSab√°);
        dataAntecedencia.setDate(dataAntecedencia.getDate() - antecedenciaDias);
        const dataAntecedenciaISO = dataAntecedencia.toISOString().split('T')[0];
        
        const mensagemAntecedencia = `Em ${antecedenciaDias} dia(s) ser√° ${sab√°.nome}. Prepare-se!`;
        agendarAlertaParaData(dataAntecedenciaISO, horaSabas, `üî• ${sab√°.nome} em breve`, mensagemAntecedencia);
      }
    });
  }
  
  // Agendar notifica√ß√µes para Lua fora de curso
  Object.keys(luaForaDeCurso).forEach(dataISO => {
    const horario = luaForaDeCurso[dataISO];
    const mensagem = `Lua fora de curso hoje das ${horario}. Evite decis√µes importantes neste per√≠odo.`;
    agendarAlertaParaData(dataISO, horario.split('‚Äì')[0], '‚è≥ Alerta Lunar', mensagem);
  });
  
  // Agendar notifica√ß√µes di√°rias
  agendarNotificacaoDiaria(config);
}

function agendarAlertaParaData(dataISO, hora, titulo, mensagem) {
  const hoje = new Date().toISOString().split('T')[0];
  const dataAlerta = new Date(dataISO + 'T' + hora);
  
  // Verificar se a data j√° passou
  if (dataAlerta < new Date()) {
    console.log(`Data ${dataISO} j√° passou, ignorando agendamento.`);
    return;
  }
  
  const tempoRestante = dataAlerta.getTime() - Date.now();
  
  if (tempoRestante > 0) {
    setTimeout(() => {
      enviarAlerta(titulo, mensagem);
    }, tempoRestante);
    
    console.log(`Alerta agendado para ${dataISO} √†s ${hora}: ${titulo}`);
  }
}

function enviarAlerta(titulo, mensagem) {
  if (Notification.permission !== 'granted') return;
  
  const corpo = `Aten√ß√£o: ${mensagem}`;
  
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.ready.then(reg => {
      reg.showNotification(titulo, {
        body: corpo,
        icon: 'icon-192.png',
        tag: 'alerta-' + Date.now(),
        requireInteraction: true
      });
    }).catch(err => {
      console.error('Erro:', err);
      new Notification(titulo, {
        body: corpo,
        icon: 'icon-192.png'
      });
    });
  } else {
    new Notification(titulo, {
      body: corpo,
      icon: 'icon-192.png'
    });
  }
}

function agendarNotificacaoDiaria(config) {
  console.log('Agendando notifica√ß√£o di√°ria...');
  
  // Agendar para amanh√£ no hor√°rio configurado
  const amanha = new Date();
  amanha.setDate(amanha.getDate() + 1);
  amanha.setHours(parseInt(config.horaDiaria.split(':')[0]));
  amanha.setMinutes(parseInt(config.horaDiaria.split(':')[1]));
  amanha.setSeconds(0);
  
  const tempoRestante = amanha.getTime() - Date.now();
  
  if (tempoRestante > 0) {
    setTimeout(() => {
      enviarNotificacaoDiaria();
      // Reagendar para o pr√≥ximo dia
      agendarNotificacaoDiaria(config);
    }, tempoRestante);
  }
}

function enviarNotificacaoDiaria() {
  if (Notification.permission !== 'granted') return;
  
  const hoje = new Date().toISOString().split('T')[0];
  const notas = load('notas') || {};
  const temNotas = Array.isArray(notas[hoje]) && notas[hoje].length > 0;
  
  let corpo = 'Lembre-se de registrar seus pensamentos e sentimentos hoje. ‚ú®';
  
  if (temNotas) {
    corpo = 'Voc√™ tem notas registradas para hoje. Reveja-as para reflex√£o. üìñ';
  }
  
  const sabaHoje = sabas2026[hoje];
  if (sabaHoje) {
    corpo = `Aten√ß√£o: Hoje √© ${sabaHoje.nome}: ${sabaHoje.significado}`;
  }
  
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.ready.then(reg => {
      reg.showNotification('üåô Lembrete Di√°rio do Grim√≥rio', {
        body: corpo,
        icon: 'icon-192.png',
        tag: 'lembrete-diario-' + Date.now()
      });
    }).catch(err => {
      console.error('Erro:', err);
      new Notification('üåô Lembrete Di√°rio do Grim√≥rio', {
        body: corpo,
        icon: 'icon-192.png'
      });
    });
  } else {
    new Notification('üåô Lembrete Di√°rio do Grim√≥rio', {
      body: corpo,
      icon: 'icon-192.png'
    });
  }
}

function agendarLembretesNotas() {
  const notasComNotificacao = load('notasComNotificacao') || {};
  
  Object.keys(notasComNotificacao).forEach(dataISO => {
    const notificacoes = notasComNotificacao[dataISO];
    
    notificacoes.forEach((notificacao, index) => {
      const { horaNota, antecedencia, texto } = notificacao;
      
      // Calcular data e hora da notifica√ß√£o
      const dataNotificacao = new Date(dataISO + 'T' + horaNota);
      dataNotificacao.setMinutes(dataNotificacao.getMinutes() - antecedencia);
      
      const tempoRestante = dataNotificacao.getTime() - Date.now();
      
      if (tempoRestante > 0) {
        setTimeout(() => {
          enviarLembreteNota(texto, horaNota);
        }, tempoRestante);
        
        console.log(`Lembrete agendado para ${dataISO} √†s ${horaNota} (${antecedencia} min antes)`);
      }
    });
  });
}

function enviarLembreteNota(textoNota, horaNota) {
  if (Notification.permission !== 'granted') return;
  
  const preview = textoNota.length > 50 ? textoNota.substring(0, 50) + '...' : textoNota;
  
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.ready.then(reg => {
      reg.showNotification(`üìù Lembrete de Nota - ${horaNota}`, {
        body: preview,
        icon: 'icon-192.png',
        tag: `lembrete-nota-${Date.now()}`
      });
    });
  } else {
    new Notification(`üìù Lembrete de Nota - ${horaNota}`, {
      body: preview,
      icon: 'icon-192.png'
    });
  }
}

// ===== TESTE DE NOTIFICA√á√ïES =====
function adicionarBotaoTeste() {
  setTimeout(() => {
    const capaDiv = document.getElementById('capa');
    if (capaDiv && !document.getElementById('btnTesteNotificacao')) {
      const btnTeste = document.createElement('button');
      btnTeste.id = 'btnTesteNotificacao';
      btnTeste.className = 'secondary';
      btnTeste.innerHTML = 'üîî Testar Notifica√ß√£o';
      btnTeste.style.marginTop = '10px';
      btnTeste.style.marginLeft = '10px';
      
      btnTeste.addEventListener('click', () => {
        if (Notification.permission === 'granted') {
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(reg => {
              reg.showNotification('üîî Teste de Notifica√ß√£o', {
                body: 'Esta √© uma notifica√ß√£o de teste do Grim√≥rio!',
                icon: 'icon-192.png',
                tag: 'teste'
              });
              alert('‚úÖ Notifica√ß√£o de teste enviada!');
            });
          } else {
            new Notification('üîî Teste de Notifica√ß√£o', {
              body: 'Esta √© uma notifica√ß√£o de teste do Grim√≥rio!',
              icon: 'icon-192.png'
            });
            alert('‚úÖ Notifica√ß√£o de teste enviada!');
          }
        } else if (Notification.permission === 'default') {
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              alert('‚úÖ Permiss√£o concedida! Clique novamente para testar.');
            }
          });
        } else {
          alert('‚ùå Permiss√£o para notifica√ß√µes foi negada.');
        }
      });
      
      const btnAlterarNome = document.getElementById('btnAlterarNome');
      if (btnAlterarNome && btnAlterarNome.parentNode) {
        btnAlterarNome.parentNode.appendChild(btnTeste);
      }
    }
  }, 1000);
}

// ===== DADOS DAS PLANILHAS =====
const sabas2026 = {
  '2026-02-01': {
    nome: 'Lughnasadh',
    tipo: 'Sab√° Maior',
    estacaoElemento: 'Ver√£o/Fogo',
    significado: 'Primeira colheita',
    rituais: 'Assar p√£es caseiros e bolos de gr√£os, expressar gratid√£o pela fartura, agradecer pelos frutos j√° colhidos, ritual de colheita e prosperidade'
  },
  '2026-03-20': {
    nome: 'Mabon',
    tipo: 'Sab√° Menor',
    estacaoElemento: 'Outono/√Ågua',
    significado: 'Equil√≠brio e colheita completa',
    rituais: 'Oferendas de ma√ß√£s e frutas da esta√ß√£o, compartilhamento de banquetes, agradecimento pela colheita, prepara√ß√£o para o recolhimento do inverno, rituais de equil√≠brio e gratid√£o'
  },
  '2026-05-01': {
    nome: 'Samhain',
    tipo: 'Sab√° Maior',
    estacaoElemento: 'Outono/Terra',
    significado: 'Ano Novo Pag√£o, Festival dos Mortos',
    rituais: 'Honrar ancestrais e entes queridos falecidos, limpeza de altares e espa√ßos sagrados, queima de pedidos ou banimentos, conex√£o com o mundo espiritual, divina√ß√£o e introspec√ß√£o'
  },
  '2026-06-21': {
    nome: 'Yule',
    tipo: 'Sab√° Menor',
    estacaoElemento: 'Inverno/Fogo',
    significado: 'Solst√≠cio de Inverno, Renascimento',
    rituais: 'Acendimento da "tora de Yule" ou velas, decora√ß√£o de √°rvores com s√≠mbolos de vida eterna, rituais para atrair a luz de volta, celebra√ß√£o do renascimento do sol, troca de presentes simb√≥licos'
  },
  '2026-08-01': {
    nome: 'Imbolc',
    tipo: 'Sab√° Maior',
    estacaoElemento: 'Inverno/√Ågua',
    significado: 'Purifica√ß√£o e prote√ß√£o',
    rituais: 'Acender muitas velas (fogo da inspira√ß√£o), dedica√ß√£o √† deusa Br√≠gida, limpezas energ√©ticas na casa, rituais de purifica√ß√£o e prote√ß√£o, prepara√ß√£o para o retorno da luz'
  },
  '2026-09-22': {
    nome: 'Ostara',
    tipo: 'Sab√° Menor',
    estacaoElemento: 'Primavera/Ar',
    significado: 'Equin√≥cio de Primavera, Fertilidade',
    rituais: 'Plantio de sementes f√≠sicas ou projetos, decora√ß√£o de ovos (s√≠mbolo de potencial), rituais de fertilidade e renova√ß√£o, celebra√ß√£o do despertar da vida, equil√≠brio entre luz e escurid√£o'
  },
  '2026-10-31': {
    nome: 'Beltane',
    tipo: 'Sab√° Maior',
    estacaoElemento: 'Primavera/Fogo',
    significado: 'Uni√£o, paix√£o e fertilidade m√°xima',
    rituais: 'Dan√ßar ao redor do "mastro de maio" (Maypole), acender fogueiras de prote√ß√£o, celebrar o amor e a beleza da natureza, rituais de uni√£o e fertilidade, coroas de flores e decora√ß√µes naturais'
  },
  '2026-12-21': {
    nome: 'Litha',
    tipo: 'Sab√° Menor',
    estacaoElemento: 'Ver√£o/Fogo',
    significado: 'Solst√≠cio de Ver√£o, Poder Solar',
    rituais: 'Rituais ao ar livre para absorver energia solar, colheita de ervas m√°gicas no auge do poder, celebra√ß√£o da vitalidade com m√∫sica e dan√ßa, fogueiras e celebra√ß√µes comunit√°rias, honrar o √°pice da luz'
  }
};

const energiasLunares = {
  'Lua Nova': {
    energiaPrincipal: 'Introspec√ß√£o, recome√ßo, potencial latente',
    acoesPositivas: 'Plantar novas inten√ß√µes e iniciar projetos, fazer planos e definir metas, meditar e se conectar consigo mesmo, rituais de manifesta√ß√£o',
    evitar: 'A√ß√µes impulsivas sem planejamento, tomar decis√µes importantes sem reflex√£o, for√ßar resultados imediatos'
  },
  'Lua Crescente': {
    energiaPrincipal: 'Crescimento, movimento, constru√ß√£o',
    acoesPositivas: 'Desenvolver projetos iniciados na Lua Nova, fazer reuni√µes e networking, come√ßar h√°bitos novos, investir em relacionamentos, estudar e aprender',
    evitar: 'Abandonar compromissos no meio do caminho, dispersar energia em muitas dire√ß√µes, desistir diante de obst√°culos'
  },
  'Lua Cheia': {
    energiaPrincipal: 'Ilumina√ß√£o, culmina√ß√£o, revela√ß√£o',
    acoesPositivas: 'Colher resultados e celebrar conquistas, ter clareza sobre situa√ß√µes, expressar emo√ß√µes de forma saud√°vel, finalizar projetos, rituais de gratid√£o',
    evitar: 'Decis√µes impulsivas baseadas em emo√ß√µes intensas, confrontos desnecess√°rios, ignorar o que est√° sendo revelado'
  },
  'Lua Minguante': {
    energiaPrincipal: 'Desapego, encerramento, limpeza',
    acoesPositivas: 'Liberar o que n√£o serve mais, encerrar ciclos e rela√ß√µes t√≥xicas, fazer limpeza f√≠sica e energ√©tica, descansar e se recolher, pr√°ticas de desapego',
    evitar: 'Iniciar novos projetos ou relacionamentos, for√ßar a√ß√£o quando o corpo pede descanso, ignorar sinais de que algo precisa terminar'
  }
};

const energiaSignoLunar = {
  '√Åries': {
    'Lua Nova': 'Momento de m√°xima coragem para iniciar projetos pessoais e retomar o protagonismo.',
    'Lua Crescente': 'Impulso para agir r√°pido e superar obst√°culos com determina√ß√£o.',
    'Lua Cheia': 'Auge da autoconfian√ßa; os desejos individuais entram em conflito ou equil√≠brio com as necessidades dos outros.',
    'Lua Minguante': 'Necessidade de controlar a impaci√™ncia e revisar impulsos agressivos antes de encerrar o ciclo.'
  },
  'Touro': {
    'Lua Nova': 'Plantio focado em estabilidade financeira, conforto e seguran√ßa material.',
    'Lua Crescente': 'Per√≠odo de nutri√ß√£o e paci√™ncia; foco em fazer as ideias "ganharem corpo" e ra√≠zes.',
    'Lua Cheia': 'Colheita de resultados concretos; momento de valorizar o prazer e o que foi constru√≠do.',
    'Lua Minguante': 'Hora de praticar o desapego material e emocional para evitar ac√∫mulos desnecess√°rios.'
  },
  'G√™meos': {
    'Lua Nova': 'In√≠cio de novos estudos, contatos e circula√ß√£o de ideias.',
    'Lua Crescente': 'Fase de muita comunica√ß√£o, trocas intelectuais e busca por informa√ß√µes.',
    'Lua Cheia': 'Clareza mental e revela√ß√µes; pensamentos que estavam nublados tornam-se objetivos.',
    'Lua Minguante': 'Momento de silenciar a mente, filtrar o excesso de informa√ß√£o e concluir conversas pendentes.'
  },
  'C√¢ncer': {
    'Lua Nova': 'Foco total na renova√ß√£o da vida √≠ntima, lar e fam√≠lia.',
    'Lua Crescente': 'Intensifica√ß√£o das emo√ß√µes, prote√ß√£o de quem se ama e fortalecimento de v√≠nculos.',
    'Lua Cheia': 'Transbordamento emocional e sensibilidade m√°xima; colheita ligada ao acolhimento.',
    'Lua Minguante': 'Convite para olhar para dentro, perdoar o pasto e buscar paz com a pr√≥pria hist√≥ria.'
  },
  'Le√£o': {
    'Lua Nova': 'Novos come√ßos ligados √† autoexpress√£o, criatividade e prazer.',
    'Lua Crescente': 'Desenvolvimento do carisma e esfor√ßo para ser notado em projetos autorais.',
    'Lua Cheia': 'Celebra√ß√£o da identidade; momento de brilho p√∫blico e reconhecimento.',
    'Lua Minguante': 'Reflex√£o sobre o excesso de ego e recolhimento para restaurar a energia vital.'
  },
  'Virgem': {
    'Lua Nova': 'Planejamento de rotinas saud√°veis e organiza√ß√£o meticulosa de tarefas.',
    'Lua Crescente': 'Trabalho detalhista e ajustes pr√°ticos para garantir que os planos funcionem.',
    'Lua Cheia': 'Resultados vis√≠veis na sa√∫de e no trabalho; clareza sobre o que precisa de melhoria t√©cnica.',
    'Lua Minguante': 'Faxina f√≠sica e mental; momento de eliminar m√©todos ou h√°bitos que n√£o servem mais.'
  },
  'Libra': {
    'Lua Nova': 'Inten√ß√µes voltadas para parcerias, acordos e harmonia est√©tica.',
    'Lua Crescente': 'Esfor√ßo para equilibrar rela√ß√µes e media√ß√£o de conflitos em andamento.',
    'Lua Cheia': 'Auge dos relacionamentos; situa√ß√µes sociais ou rom√¢nticas chegam ao ponto cr√≠tico ou de √°pice.',
    'Lua Minguante': 'Avalia√ß√£o da justi√ßa nas trocas e finaliza√ß√£o de compromissos que n√£o t√™m reciprocidade.'
  },
  'Escorpi√£o': {
    'Lua Nova': 'Mergulho profundo em transforma√ß√µes internas e novos investimentos emocionais ou financeiros.',
    'Lua Crescente': 'Fase de regenera√ß√£o e persist√™ncia emocional intensa diante de crises.',
    'Lua Cheia': 'Revela√ß√µes de segredos ou emo√ß√µes ocultas; momento de purga√ß√£o e intensidade sexual.',
    'Lua Minguante': 'Desapego de traumas e limpeza de energias t√≥xicas acumuladas.'
  },
  'Sagit√°rio': {
    'Lua Nova': 'Novos horizontes, viagens ou estudos superiores; busca por novos sentidos de vida.',
    'Lua Crescente': 'Expans√£o de ideias e otimismo para seguir em frente com grandes planos.',
    'Lua Cheia': 'Culmina√ß√£o de aventuras ou processos acad√™micos; celebra√ß√£o da liberdade conquistada.',
    'Lua Minguante': 'Reflex√£o sobre a verdade e revis√£o de cren√ßas antes de iniciar uma nova busca.'
  },
  'Capric√≥rnio': {
    'Lua Nova': 'Metas de longo prazo, carreira e constru√ß√£o de autoridade.',
    'Lua Crescente': 'Disciplina r√≠gida e supera√ß√£o de obst√°culos estruturais para subir na vida.',
    'Lua Cheia': 'Reconhecimento profissional e social; colheita do esfor√ßo e da perseveran√ßa.',
    'Lua Minguante': 'Revis√£o de responsabilidades e encerramento de cargos ou projetos que j√° cumpriram seu tempo.'
  },
  'Aqu√°rio': {
    'Lua Nova': 'Ideias inovadoras, projetos coletivos e foco em causas sociais ou tecnol√≥gicas.',
    'Lua Crescente': 'Movimenta√ß√£o em grupos e colabora√ß√£o para ver mudan√ßas acontecerem.',
    'Lua Cheia': 'Resultados de movimentos sociais ou amizades; clareza sobre o papel do indiv√≠duo no coletivo.',
    'Lua Minguante': 'Avalia√ß√£o da pr√≥pria liberdade e distanciamento de c√≠rculos sociais que limitam a autenticidade.'
  },
  'Peixes': {
    'Lua Nova': 'In√≠cio de ciclos espirituais, art√≠sticos ou de cura emocional profunda.',
    'Lua Crescente': 'Sensibilidade agu√ßada e desenvolvimento da intui√ß√£o para guiar as a√ß√µes.',
    'Lua Cheia': 'Auge da imagina√ß√£o e conex√£o com o divino; sonhos que se tornam n√≠tidos ou se realizam.',
    'Lua Minguante': 'Entrega, dissolu√ß√£o de ilus√µes e prepara√ß√£o espiritual para o renascimento.'
  }
};

const energiaNumerologia = {
  1: { potencial: 'In√≠cio, lideran√ßa, independ√™ncia', risco: 'Ego√≠smo, impulsividade' },
  2: { potencial: 'Coopera√ß√£o, diplomacia, sensibilidade', risco: 'Indecis√£o, depend√™ncia emocional' },
  3: { potencial: 'Criatividade, express√£o, alegria', risco: 'Superficialidade, dispers√£o' },
  4: { potencial: 'Estabilidade, organiza√ß√£o, trabalho', risco: 'Rigidez, resist√™ncia √† mudan√ßa' },
  5: { potencial: 'Liberdade, mudan√ßa, aventura', risco: 'Inconst√¢ncia, irresponsabilidade' },
  6: { potencial: 'Harmonia, responsabilidade, cuidado', risco: 'Perfeccionismo, controle excessivo' },
  7: { potencial: 'Introspec√ß√£o, sabedoria, espiritualidade', risco: 'Isolamento, ceticismo excessivo' },
  8: { potencial: 'Poder, realiza√ß√£o material, abund√¢ncia', risco: 'Materialismo, ambi√ß√£o desmedida' },
  9: { potencial: 'Compaix√£o, completude, humanitarismo', risco: 'M√°rtir, apego ao passado' }
};

const cicloMenstrualFaseLunar = {
  'Lua Nova': {
    'menstruacao': 'Energia de recolhimento profundo. Momento ideal para descansar e ouvir seu corpo.',
    'pre_ovulacao': 'Sensa√ß√£o de renascimento e novas possibilidades. Energia criativa em ascens√£o.',
    'ovulacao': 'Intui√ß√£o agu√ßada e conex√£o com seus desejos mais profundos.',
    'pre_menstrual': 'Reflex√£o sobre o que precisa ser liberado para o pr√≥ximo ciclo.'
  },
  'Lua Crescente': {
    'menstruacao': 'For√ßa vital retornando gradualmente. Bom momento para planejamentos suaves.',
    'pre_ovulacao': 'Energia construtiva em alta. Ideal para colocar planos em a√ß√£o.',
    'ovulacao': 'Poder de manifesta√ß√£o no auge. Momento f√©rtil em todos os sentidos.',
    'pre_menstrual': 'Consolida√ß√£o de aprendizados do ciclo.'
  },
  'Lua Cheia': {
    'menstruacao': 'Emo√ß√µes intensas √† flor da pele. Permita-se sentir sem julgamentos.',
    'pre_ovulacao': 'Clareza sobre seus desejos e inten√ß√µes.',
    'ovulacao': 'Poder feminino em evid√™ncia. Celebre sua sensualidade e for√ßa.',
    'pre_menstrual': 'Revela√ß√µes emocionais podem surgir com mais intensidade.'
  },
  'Lua Minguante': {
    'menstruacao': 'Libera√ß√£o f√≠sica e emocional. Deixe ir o que n√£o serve mais.',
    'pre_ovulacao': 'Prepara√ß√£o interna para novas fases.',
    'ovulacao': 'Intui√ß√£o profundamente conectada com ciclos maiores.',
    'pre_menstrual': 'Processamento emocional necess√°rio antes do novo in√≠cio.'
  }
};

const lunacoes2026 = {
  '2026-01-03': { fase: 'Lua Cheia', signo: 'C√¢ncer', icone: 'üåï' },
  '2026-01-10': { fase: 'Lua Minguante', signo: 'Libra', icone: 'üåò' },
  '2026-01-18': { fase: 'Lua Nova', signo: 'Capric√≥rnio', icone: 'üåë' },
  '2026-01-26': { fase: 'Lua Crescente', signo: 'Touro', icone: 'üåí' },
  '2026-02-01': { fase: 'Lua Cheia', signo: 'Le√£o', icone: 'üåï' },
  '2026-02-09': { fase: 'Lua Minguante', signo: 'Escorpi√£o', icone: 'üåò' },
  '2026-02-17': { fase: 'Lua Nova', signo: 'Aqu√°rio', icone: 'üåë' },
  '2026-02-24': { fase: 'Lua Crescente', signo: 'G√™meos', icone: 'üåí' },
  '2026-03-03': { fase: 'Lua Cheia', signo: 'Virgem', icone: 'üåï' },
  '2026-03-11': { fase: 'Lua Minguante', signo: 'Sagit√°rio', icone: 'üåò' },
  '2026-03-18': { fase: 'Lua Nova', signo: 'Peixes', icone: 'üåë' },
  '2026-03-25': { fase: 'Lua Crescente', signo: 'C√¢ncer', icone: 'üåí' },
  '2026-04-01': { fase: 'Lua Cheia', signo: 'Libra', icone: 'üåï' },
  '2026-04-10': { fase: 'Lua Minguante', signo: 'Capric√≥rnio', icone: 'üåò' },
  '2026-04-17': { fase: 'Lua Nova', signo: '√Åries', icone: 'üåë' },
  '2026-04-23': { fase: 'Lua Crescente', signo: 'Le√£o', icone: 'üåí' },
  '2026-05-01': { fase: 'Lua Cheia', signo: 'Escorpi√£o', icone: 'üåï' },
  '2026-05-09': { fase: 'Lua Minguante', signo: 'Aqu√°rio', icone: 'üåò' },
  '2026-05-16': { fase: 'Lua Nova', signo: 'Touro', icone: 'üåë' },
  '2026-05-23': { fase: 'Lua Crescente', signo: 'Virgem', icone: 'üåí' },
  '2026-05-31': { fase: 'Lua Cheia', signo: 'Sagit√°rio', icone: 'üåï' },
  '2026-06-08': { fase: 'Lua Minguante', signo: 'Peixes', icone: 'üåò' },
  '2026-06-14': { fase: 'Lua Nova', signo: 'G√™meos', icone: 'üåë' },
  '2026-06-21': { fase: 'Lua Crescente', signo: 'Virgem', icone: 'üåí' },
  '2026-06-29': { fase: 'Lua Cheia', signo: 'Capric√≥rnio', icone: 'üåï' },
  '2026-07-07': { fase: 'Lua Minguante', signo: '√Åries', icone: 'üåò' },
  '2026-07-14': { fase: 'Lua Nova', signo: 'C√¢ncer', icone: 'üåë' },
  '2026-07-21': { fase: 'Lua Crescente', signo: 'Escorpi√£o', icone: 'üåí' },
  '2026-07-29': { fase: 'Lua Cheia', signo: 'Aqu√°rio', icone: 'üåï' },
  '2026-08-05': { fase: 'Lua Minguante', signo: 'Touro', icone: 'üåò' },
  '2026-08-12': { fase: 'Lua Nova', signo: 'Le√£o', icone: 'üåë' },
  '2026-08-19': { fase: 'Lua Crescente', signo: 'Escorpi√£o', icone: 'üåí' },
  '2026-08-28': { fase: 'Lua Cheia', signo: 'Peixes', icone: 'üåï' },
  '2026-09-04': { fase: 'Lua Minguante', signo: 'G√™meos', icone: 'üåò' },
  '2026-09-11': { fase: 'Lua Nova', signo: 'Virgem', icone: 'üåë' },
  '2026-09-18': { fase: 'Lua Crescente', signo: 'Sagit√°rio', icone: 'üåí' },
  '2026-09-26': { fase: 'Lua Cheia', signo: '√Åries', icone: 'üåï' },
  '2026-10-03': { fase: 'Lua Minguante', signo: 'C√¢ncer', icone: 'üåò' },
  '2026-10-10': { fase: 'Lua Nova', signo: 'Libra', icone: 'üåë' },
  '2026-10-18': { fase: 'Lua Crescente', signo: 'Aqu√°rio', icone: 'üåí' },
  '2026-10-26': { fase: 'Lua Cheia', signo: 'Touro', icone: 'üåï' },
  '2026-11-01': { fase: 'Lua Minguante', signo: 'Le√£o', icone: 'üåò' },
  '2026-11-09': { fase: 'Lua Nova', signo: 'Escorpi√£o', icone: 'üåë' },
  '2026-11-17': { fase: 'Lua Crescente', signo: 'Peixes', icone: 'üåí' },
  '2026-11-24': { fase: 'Lua Cheia', signo: 'G√™meos', icone: 'üåï' },
  '2026-12-01': { fase: 'Lua Minguante', signo: 'Virgem', icone: 'üåò' },
  '2026-12-08': { fase: 'Lua Nova', signo: 'Sagit√°rio', icone: 'üåë' },
  '2026-12-17': { fase: 'Lua Crescente', signo: 'Peixes', icone: 'üåí' },
  '2026-12-23': { fase: 'Lua Cheia', signo: 'G√™meos', icone: 'üåï' },
  '2026-12-30': { fase: 'Lua Minguante', signo: 'Libra', icone: 'üåò' }
};

const luaForaDeCurso = {
  '2026-01-02': '09:23‚Äì10:09',
  '2026-02-05': '14:10‚Äì15:02',
  '2026-03-07': '22:40‚Äì23:30',
  '2026-04-11': '06:15‚Äì07:01',
  '2026-05-04': '18:50‚Äì19:44',
  '2026-06-09': '03:12‚Äì04:00',
  '2026-07-12': '11:30‚Äì12:18',
  '2026-08-06': '20:05‚Äì21:00',
  '2026-09-10': '08:44‚Äì09:33',
  '2026-10-08': '16:10‚Äì17:02',
  '2026-11-09': '01:22‚Äì02:10',
  '2026-12-07': '13:40‚Äì14:28'
};

// ===== FUN√á√ïES AUXILIARES =====
function calcularNumeroEnergia(dataISO) {
  const perfil = load('perfil') || {};
  const dataNascimento = perfil.dataNascimento;
  
  if (!dataNascimento) return null;
  
  try {
    const partes = dataNascimento.split('-');
    const dia = parseInt(partes[2]);
    const mes = parseInt(partes[1]);
    const anoAtual = 2026;
    
    let soma = dia + mes + anoAtual;
    
    while (soma > 9) {
      soma = soma.toString().split('').reduce((acc, num) => acc + parseInt(num), 0);
    }
    
    return soma;
  } catch (e) {
    console.error('Erro ao calcular numerologia:', e);
    return null;
  }
}

function determinarFaseCiclo(dataISO) {
  const perfil = load('perfil') || {};
  const ciclo = perfil.ciclo;
  
  if (!ciclo) return null;
  
  try {
    const dataCiclo = new Date(ciclo);
    const dataAtual = new Date(dataISO);
    
    const diffTime = dataAtual - dataCiclo;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    const cicloDia = diffDays % 28;
    
    if (cicloDia >= 0 && cicloDia <= 7) return 'menstruacao';
    if (cicloDia >= 8 && cicloDia <= 14) return 'pre_ovulacao';
    if (cicloDia >= 15 && cicloDia <= 21) return 'ovulacao';
    return 'pre_menstrual';
    
  } catch (e) {
    console.error('Erro ao determinar fase do ciclo:', e);
    return null;
  }
}

function avaliarDia(dataISO) {
  const perfil = load('perfil') || {};
  const lua = lunacoes2026[dataISO];
  const saba = sabas2026[dataISO];
  
  let oraculoHTML = '';
  
  if (saba) {
    oraculoHTML += `<strong>üî• Hoje √© dia do Sab√° ${saba.nome} (${saba.tipo}).</strong><br>`;
    oraculoHTML += `Dia de celebrar ${saba.estacaoElemento.toLowerCase()}.<br><br>`;
  }
  
  if (lua) {
    const energiaFase = energiasLunares[lua.fase] || {};
    const energiaSigno = energiaSignoLunar[lua.signo] || {};
    
    oraculoHTML += `<strong>üåô Lua em ${lua.signo}:</strong><br>`;
    oraculoHTML += `Dia de ${energiaFase.energiaPrincipal || 'energia lunar'}. `;
    oraculoHTML += `Momento para ${energiaSigno[lua.fase] || 'alinhar-se com a energia do signo'}.<br><br>`;
  } else {
    oraculoHTML += `<strong>üåô Lua em tr√¢nsito:</strong><br>`;
    oraculoHTML += `Continuidade do ciclo lunar em andamento.<br><br>`;
  }
  
  oraculoHTML += `<strong>‚ö° Energia do dia:</strong><br>`;
  
  const numeroEnergia = calcularNumeroEnergia(dataISO);
  if (numeroEnergia && energiaNumerologia[numeroEnergia]) {
    const energiaNum = energiaNumerologia[numeroEnergia];
    oraculoHTML += `${energiaNum.potencial}. `;
    oraculoHTML += `Aten√ß√£o para ${energiaNum.risco.toLowerCase()}.<br>`;
  }
  
  const faseCiclo = determinarFaseCiclo(dataISO);
  if (lua && faseCiclo && cicloMenstrualFaseLunar[lua.fase] && cicloMenstrualFaseLunar[lua.fase][faseCiclo]) {
    oraculoHTML += `Voc√™ poder√° se sentir ${cicloMenstrualFaseLunar[lua.fase][faseCiclo].toLowerCase()}<br><br>`;
  } else if (lua && !perfil.ciclo) {
    const energiaFase = energiasLunares[lua.fase] || {};
    oraculoHTML += `Dia para focar em ${energiaFase.acoesPositivas ? energiaFase.acoesPositivas.split(',')[0] : 'harmonia interna'}.<br><br>`;
  } else {
    oraculoHTML += `Aten√ß√£o √†s suas necessidades internas hoje.<br><br>`;
  }
  
  oraculoHTML += `<strong>‚ú® Ritual sugerido:</strong><br>`;
  if (saba) {
    oraculoHTML += `Dia de ${saba.rituais.split(',')[0]} e `;
  }
  
  if (lua) {
    if (lua.fase === 'Lua Cheia') {
      oraculoHTML += 'ritual de gratid√£o, escrita consciente e celebra√ß√£o simb√≥lica.';
    } else if (lua.fase === 'Lua Nova') {
      oraculoHTML += 'plantio de inten√ß√µes, sil√™ncio ritual e visualiza√ß√£o.';
    } else if (lua.fase === 'Lua Crescente') {
      oraculoHTML += 'a√ß√µes progressivas, fortalecimento de h√°bitos e foco.';
    } else if (lua.fase === 'Lua Minguante') {
      oraculoHTML += 'limpeza energ√©tica, desapego e descanso consciente.';
    } else {
      oraculoHTML += 'pr√°tica simples de autocuidado e observa√ß√£o.';
    }
  } else {
    oraculoHTML += 'pr√°tica simples de autocuidado e observa√ß√£o.';
  }
  
  return oraculoHTML;
}

// ===== FUN√á√ïES DO PLANNER =====
function criarPlanner() {
  grid.innerHTML = '';
  const total = new Date(anoAtual, mesAtual + 1, 0).getDate();
  const inicio = new Date(anoAtual, mesAtual, 1).getDay();
  mesTitulo.textContent = new Date(anoAtual, mesAtual).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });

  for (let i = 0; i < inicio; i++) {
    const v = document.createElement('div');
    v.style.visibility = 'hidden';
    grid.appendChild(v);
  }

  const notas = load('notas') || {};
  const sentimentos = load('sentimentos') || {};

  for (let d = 1; d <= total; d++) {
    const dataISO = `${anoAtual}-${String(mesAtual + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
    const el = document.createElement('div');
    el.className = 'dia';

    let icones = '';
    if (lunacoes2026[dataISO]) icones += lunacoes2026[dataISO].icone;
    if (sabas2026[dataISO]) icones += 'üî•';
    if (luaForaDeCurso[dataISO]) icones += '‚è≥';

    el.innerHTML = `<strong>${d}</strong>` + (icones ? `<div class="iconesTopo">${icones}</div>` : '');

    if ((Array.isArray(notas[dataISO]) && notas[dataISO].length) || sentimentos[dataISO]) {
      el.innerHTML += `<span class="estrela">‚ú∂</span>`;
      
      const p = document.createElement('div');
      p.className = 'preview';
      
      if (Array.isArray(notas[dataISO]) && notas[dataISO].length) {
        p.textContent = notas[dataISO][notas[dataISO].length - 1].texto.substring(0, 40) + '...';
      } else if (sentimentos[dataISO]) {
        p.textContent = 'üíñ ' + sentimentos[dataISO].substring(0, 40) + '...';
      }
      
      el.appendChild(p);
    }

    el.addEventListener('click', () => abrirModal(dataISO, d));
    grid.appendChild(el);
  }
}

// ===== FUN√á√ÉO ABRIR MODAL =====
function abrirModal(dataISO, dia) {
  diaAtual = dataISO;
  document.getElementById('modalTitulo').textContent = `Dia ${dia}`;
  
  oraculo.innerHTML = avaliarDia(dataISO);
  
  notasSalvas.innerHTML = '';
  sentimentosSalvos.innerHTML = '';
  
  const notas = load('notas') || {};
  if (Array.isArray(notas[dataISO])) {
    notas[dataISO].forEach((n, index) => {
      const div = document.createElement('div');
      div.className = 'nota-item';
      div.innerHTML = `
        <div class="nota-hora">${n.hora || 'Sem hor√°rio'}</div>
        <div class="nota-texto">${n.texto}</div>
        <button class="btn-apagar-nota" data-index="${index}" title="Apagar esta nota">üóëÔ∏è</button>
      `;
      notasSalvas.appendChild(div);
    });
    
    document.querySelectorAll('.btn-apagar-nota').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const index = parseInt(this.getAttribute('data-index'));
        apagarNota(index);
      });
    });
  }
  
  const sentimentos = load('sentimentos') || {};
  if (sentimentos[dataISO]) {
    const div = document.createElement('div');
    div.className = 'sentimento-item';
    div.innerHTML = `
      <div style="color:var(--color-mystic-purple);font-weight:bold;font-size:0.875rem;">üíñ Impress√µes e Sentimentos</div>
      <div style="color:var(--color-text-primary);font-size:0.9375rem;margin-top:8px;">${sentimentos[dataISO]}</div>
      <button class="btn-apagar-sentimento" title="Apagar sentimentos">üóëÔ∏è</button>
    `;
    sentimentosSalvos.appendChild(div);
    
    document.querySelector('.btn-apagar-sentimento').addEventListener('click', function(e) {
      e.stopPropagation();
      apagarSentimento();
    });
  }
  
  const sentimentosField = document.getElementById('sentimentos');
  if (sentimentos[dataISO]) {
    sentimentosField.value = sentimentos[dataISO];
  } else {
    sentimentosField.value = '';
  }
  
  document.getElementById('notaHora').value = '';
  document.getElementById('notaTexto').value = '';
  
  const notificarNotaSelect = document.getElementById('notificarNota');
  const configNotificacaoDiv = document.getElementById('configNotificacao');
  
  notificarNotaSelect.value = 'nao';
  configNotificacaoDiv.style.display = 'none';
  
  notificarNotaSelect.addEventListener('change', function() {
    if (this.value === 'sim') {
      configNotificacaoDiv.style.display = 'block';
    } else {
      configNotificacaoDiv.style.display = 'none';
    }
  });
  
  modal.style.display = 'flex';
}

function apagarNota(index) {
  if (!confirm('Tem certeza que deseja apagar esta nota?')) {
    return;
  }
  
  const notas = load('notas') || {};
  
  if (Array.isArray(notas[diaAtual]) && notas[diaAtual][index]) {
    notas[diaAtual].splice(index, 1);
    
    if (notas[diaAtual].length === 0) {
      delete notas[diaAtual];
    }
    
    save('notas', notas);
    abrirModal(diaAtual, diaAtual.split('-')[2]);
    criarPlanner();
  }
}

function apagarSentimento() {
  if (!confirm('Tem certeza que deseja apagar suas impress√µes e sentimentos deste dia?')) {
    return;
  }
  
  const sentimentos = load('sentimentos') || {};
  
  if (sentimentos[diaAtual]) {
    delete sentimentos[diaAtual];
    save('sentimentos', sentimentos);
    abrirModal(diaAtual, diaAtual.split('-')[2]);
    criarPlanner();
  }
}

function salvarNota() {
  const notaTexto = document.getElementById('notaTexto').value.trim();
  const sentimentosTexto = document.getElementById('sentimentos').value.trim();
  const notaHora = document.getElementById('notaHora').value;
  const notificarNota = document.getElementById('notificarNota').value;
  const tempoAntecedencia = parseInt(document.getElementById('tempoAntecedencia').value);
  
  if (notaTexto) {
    const notas = load('notas') || {};
    if (!Array.isArray(notas[diaAtual])) notas[diaAtual] = [];
    notas[diaAtual].push({ hora: notaHora, texto: notaTexto });
    save('notas', notas);
    
    if (notificarNota === 'sim' && notaHora) {
      agendarNotificacaoNota(diaAtual, notaHora, tempoAntecedencia, notaTexto);
    }
  }
  
  if (sentimentosTexto) {
    const sentimentos = load('sentimentos') || {};
    sentimentos[diaAtual] = sentimentosTexto;
    save('sentimentos', sentimentos);
  }
  
  if (!notaTexto && !sentimentosTexto) {
    alert('Por favor, escreva uma nota ou seus sentimentos!');
    return;
  }
  
  fecharModal();
  criarPlanner();
}

function agendarNotificacaoNota(dataISO, horaNota, antecedenciaMinutos, textoNota) {
  const notasComNotificacao = load('notasComNotificacao') || {};
  
  if (!Array.isArray(notasComNotificacao[dataISO])) {
    notasComNotificacao[dataISO] = [];
  }
  
  notasComNotificacao[dataISO].push({
    horaNota: horaNota,
    antecedencia: antecedenciaMinutos,
    texto: textoNota
  });
  
  save('notasComNotificacao', notasComNotificacao);
  
  // Reagendar todos os lembretes
  agendarLembretesNotas();
}

function fecharModal() {
  modal.style.display = 'none';
  document.getElementById('notaTexto').value = '';
  document.getElementById('notaHora').value = '';
  document.getElementById('sentimentos').value = '';
}

// ===== FUN√á√ïES DO LIVRO DA BRUXA PR√ìSPERA =====
function recalcular() {
  const categorias = ['sustento', 'florescimento', 'centelha', 'abundancia'];
  let somaTotal = 0;

  categorias.forEach(cat => {
    let soma = 0;
    document.querySelectorAll(`#${cat} input[type="number"]`).forEach(i => {
      soma += Number(i.value) || 0;
    });
    if (document.getElementById(`total-${cat}`)) {
      document.getElementById(`total-${cat}`).textContent = soma.toFixed(2);
    }
    somaTotal += soma;
  });

  const totalAbundancia = Number(document.getElementById('total-abundancia').textContent) || 0;
  document.getElementById('saldo').textContent = (totalAbundancia - somaTotal).toFixed(2);
}

function addLinha(id, tipo) {
  const tbody = document.getElementById(id);
  if (!tbody) return;

  const tr = document.createElement('tr');

  const tdDesc = document.createElement('td');
  const inputDesc = document.createElement('input');
  inputDesc.placeholder = tipo === 'ganho' ? 'Descreva o ganho' : 'Descreva o gasto';
  tdDesc.appendChild(inputDesc);

  const tdValor = document.createElement('td');
  const inputValor = document.createElement('input');
  inputValor.type = 'number';
  inputValor.placeholder = '0.00';
  inputValor.oninput = recalcular;
  tdValor.appendChild(inputValor);

  const tdAcao = document.createElement('td');
  const btnRemover = document.createElement('button');
  btnRemover.textContent = '‚úñ';
  btnRemover.className = 'remover';
  btnRemover.onclick = () => tr.remove();
  tdAcao.appendChild(btnRemover);

  tr.appendChild(tdDesc);
  tr.appendChild(tdValor);
  tr.appendChild(tdAcao);

  tbody.appendChild(tr);
}

// ===== NAVEGA√á√ÉO =====
document.getElementById('irPlanner').onclick = () => {
  capa.style.display = 'none';
  planner.style.display = 'block';
  const p = load('perfil');
  if (p) perfilEl.textContent = `${p.nome} ¬∑ ${p.signo}`;
  criarPlanner();
};

document.getElementById('irProspera').onclick = () => {
  capa.style.display = 'none';
  prospera.style.display = 'block';
};

document.getElementById('voltarCapa').onclick = () => {
  planner.style.display = 'none';
  capa.style.display = 'block';
};

document.getElementById('voltarCapa2').onclick = () => {
  prospera.style.display = 'none';
  capa.style.display = 'block';
};

document.getElementById('mesAnterior').onclick = () => {
  mesAtual--;
  if (mesAtual < 0) {
    mesAtual = 11;
    anoAtual--;
  }
  criarPlanner();
};

document.getElementById('mesProximo').onclick = () => {
  mesAtual++;
  if (mesAtual > 11) {
    mesAtual = 0;
    anoAtual++;
  }
  criarPlanner();
};

// ===== EVENTOS DO MODAL =====
document.getElementById('btnFechar').onclick = fecharModal;
document.getElementById('btnSalvarNota').onclick = salvarNota;

// ===== INICIALIZA√á√ÉO =====
addLinha('sustento');
addLinha('abundancia', 'ganho');
addLinha('florescimento');
addLinha('centelha');

// Adicionar bot√£o de teste ap√≥s carregar
window.addEventListener('load', () => {
  setTimeout(adicionarBotaoTeste, 1500);
});
</script>
</body>
</html>
